<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>å©šå®´åº§ä½èˆ‡ç°½åˆ°ç³»çµ±</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts: Noto Sans TC & Great Vibes (Cursive) -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&family=Great+Vibes&display=swap" rel="stylesheet">
    <!-- Font Awesome Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['"Noto Sans TC"', 'sans-serif'],
                        cursive: ['"Great Vibes"', 'cursive'],
                    },
                    colors: {
                        wedding: {
                            red: '#8a1c28', // å‹ƒè‰®ç¬¬ç´…
                            darkRed: '#5a121a', // æ·±ç´…èƒŒæ™¯
                            gold: '#c5a059', // é¦™æª³é‡‘
                            light: '#fdfbf7', // ç±³ç™½åº•è‰²
                            green: '#4a7c59', // ç°½åˆ°ç¶ 
                            pink: '#fce7e9',
                            blue: '#e0f2fe', // ç”·å®¶è—
                        }
                    },
                    boxShadow: {
                        'up': '0 -10px 25px -5px rgba(0, 0, 0, 0.1), 0 -8px 10px -6px rgba(0, 0, 0, 0.1)',
                        'card': '0 4px 20px rgba(138, 28, 40, 0.08)',
                    }
                }
            }
        }
    </script>

    <style>
        body {
            background-color: #fdfbf7;
            -webkit-tap-highlight-color: transparent;
            min-height: 100vh;
        }

        /* èŠ±å‰ç·šæ¢è—è¡“èƒŒæ™¯ */
        .floral-bg {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -2;
            background-image: url('https://img.freepik.com/free-vector/hand-drawn-minimal-background_23-2148999829.jpg?w=1380&t=st=1703600000~exp=1703600600~hmac=fake_signature');
            background-size: 400px;
            background-repeat: repeat;
            opacity: 0.05;
            filter: sepia(100%) hue-rotate(320deg) saturate(20%);
            pointer-events: none;
        }

        /* Shirley & Oscar æš—èŠ±æµ®æ°´å°èƒŒæ™¯ */
        .watermark-bg {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='300' height='200' viewBox='0 0 300 200'%3E%3Ctext x='150' y='100' font-family='Great Vibes' font-size='40' fill='%238a1c28' fill-opacity='0.04' transform='rotate(-20 150 100)' text-anchor='middle' dominant-baseline='middle'%3EShirley %26 Oscar%3C/text%3E%3C/svg%3E");
            background-repeat: repeat;
            pointer-events: none;
        }

        /* å…§å®¹é®ç½© */
        .content-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1;
            background: radial-gradient(circle, rgba(253,251,247,0.4) 0%, rgba(253,251,247,0.8) 100%);
            pointer-events: none;
        }

        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        .transition-all-300 { transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); }

        /* ç°½åˆ°ç‹€æ…‹æ¨£å¼ */
        .guest-card.checked-in {
            background: linear-gradient(to bottom right, #f0fdf4, #dcfce7);
            border-color: #86efac;
        }
        .guest-card.checked-in .avatar-box {
            background-color: #16a34a;
            color: white;
        }
        .guest-card.checked-in .check-icon {
            opacity: 1;
            transform: scale(1);
        }

        /* Bottom Navigation Active State */
        .nav-item.active {
            color: #8a1c28;
        }
        .nav-item.active i {
            transform: translateY(-2px);
        }
        
        /* Contact Card Hover */
        .contact-card:active {
            transform: scale(0.98);
            background-color: #fce7e9;
        }

        /* Timeline Styles */
        .timeline-line {
            position: absolute;
            left: 24px;
            top: 20px;
            bottom: 20px;
            width: 2px;
            background: #e5e7eb;
            z-index: 0;
        }
        .timeline-item {
            position: relative;
            padding-left: 60px;
            margin-bottom: 28px;
            z-index: 1;
        }
        .timeline-dot {
            position: absolute;
            left: 16px;
            top: 4px;
            width: 18px;
            height: 18px;
            background: #fff;
            border: 4px solid #8a1c28;
            border-radius: 50%;
            z-index: 2;
        }
        .timeline-time {
            font-weight: bold;
            color: #8a1c28;
            font-size: 0.95rem;
            margin-bottom: 2px;
        }
        .timeline-location {
            font-size: 0.75rem;
            color: #9ca3af;
            display: flex;
            align-items: center;
            gap: 4px;
            margin-top: 2px;
        }

        /* Mahjong Toggle Button Style */
        .mj-toggle.active {
            background-color: #8a1c28;
            color: white;
            border-color: #8a1c28;
        }
        .mj-toggle.active .sub-text {
            color: #fbbf24;
        }

        /* Header Transitions */
        #mainHeader {
            transition: padding 0.3s ease, border-radius 0.3s ease, box-shadow 0.3s ease;
        }
        #headerSubtitle, #headerDivider, #header-stats {
            transition: max-height 0.3s ease, opacity 0.3s ease, margin 0.3s ease;
        }
        #headerTitleWrapper {
            transition: transform 0.3s ease;
        }
    </style>
</head>
<body class="text-gray-800 antialiased pb-24">

    <div class="floral-bg"></div>
    <div class="watermark-bg"></div>
    <div class="content-overlay"></div>

    <!-- Header (Fixed) -->
    <header id="mainHeader" class="fixed top-0 left-0 w-full bg-gradient-to-br from-wedding-red to-wedding-darkRed text-white pt-10 pb-8 px-6 rounded-b-[2.5rem] shadow-xl z-50 overflow-hidden">
        <div class="absolute inset-0 opacity-10" style="background-image: url('https://www.transparenttextures.com/patterns/black-linen.png');"></div>
        
        <div class="relative z-10 flex flex-col items-center">
            <!-- Subtitle -->
            <div id="headerSubtitle" class="max-h-10 opacity-100 mb-2 overflow-hidden">
                 <h2 class="text-wedding-gold text-xs font-bold tracking-[0.3em] uppercase opacity-90 text-center">Wedding Reception</h2>
            </div>

            <!-- Title -->
            <div id="headerTitleWrapper" class="transform origin-center">
                <h1 class="text-5xl font-cursive text-white drop-shadow-lg transform -rotate-2 whitespace-nowrap">Shirley & Oscar</h1>
            </div>
            
            <!-- Divider -->
            <div id="headerDivider" class="w-16 h-0.5 bg-wedding-gold/50 rounded-full mt-2 max-h-1 opacity-100"></div>

            <!-- Stats (Only visible in Guests tab, toggled by JS) -->
            <div id="header-stats" class="w-full mt-8 max-h-[100px] opacity-100 overflow-hidden flex justify-between items-end transition-all duration-300">
                <div class="flex gap-3 overflow-x-auto pb-2 no-scrollbar w-full mr-4">
                    <div class="bg-white/10 backdrop-blur-md rounded-2xl p-3 min-w-[85px] border border-white/10 shadow-lg text-center">
                        <div class="text-[10px] text-gray-300 mb-1 uppercase tracking-wide">ç¸½äººæ•¸</div>
                        <div class="text-xl font-bold" id="totalHeadcount">0</div>
                    </div>
                    <div class="bg-green-900/40 backdrop-blur-md rounded-2xl p-3 min-w-[85px] border border-green-400/30 shadow-lg text-center">
                        <div class="text-[10px] text-green-200 mb-1 uppercase tracking-wide">å·²ç°½åˆ°</div>
                        <div class="text-xl font-bold text-green-300" id="checkedInCount">0</div>
                    </div>
                    <div class="bg-white/10 backdrop-blur-md rounded-2xl p-3 min-w-[85px] border border-white/10 shadow-lg text-center">
                        <div class="text-[10px] text-gray-300 mb-1 uppercase tracking-wide">æœªåˆ°</div>
                        <div class="text-xl font-bold text-wedding-gold" id="pendingCount">0</div>
                    </div>
                </div>

                <div class="relative w-14 h-14 flex items-center justify-center shrink-0 mb-2">
                    <svg class="transform -rotate-90 w-14 h-14">
                        <circle cx="28" cy="28" r="24" stroke="currentColor" stroke-width="3" fill="transparent" class="text-white/10" />
                        <circle id="progressCircle" cx="28" cy="28" r="24" stroke="#c5a059" stroke-width="3" fill="transparent" stroke-dasharray="150.7" stroke-dashoffset="150.7" class="transition-all duration-1000 ease-out" />
                    </svg>
                    <span class="absolute text-[11px] font-bold" id="progressText">0%</span>
                </div>
            </div>
        </div>
    </header>

    <!-- Spacer to push content down from fixed header -->
    <div id="headerSpacer" class="transition-all duration-300"></div>

    <!-- Main Content -->
    <div class="relative z-20" id="mainScrollContainer">
        
        <!-- TAB 1: è³“å®¢åå–® -->
        <main id="tab-guests" class="px-4 py-6">
            <div class="bg-white rounded-2xl shadow-card p-4 mb-6 flex items-center gap-3 sticky top-[120px] z-30 ring-1 ring-gray-100/50 transition-all duration-300" id="searchBar">
                <div class="bg-gray-50 rounded-full w-10 h-10 flex items-center justify-center text-wedding-red/50 shrink-0">
                    <i class="fas fa-search"></i>
                </div>
                <input type="text" id="searchInput" placeholder="æœå°‹è³“å®¢å§“å..." class="bg-transparent w-full outline-none text-gray-700 placeholder-gray-400 font-medium h-full">
                <button onclick="clearSearch()" id="clearSearchBtn" class="hidden text-gray-400 p-2"><i class="fas fa-times"></i></button>
            </div>
            <div id="tablesContainer" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-5"></div>
        </main>

        <!-- TAB 2: è¯çµ¡è³‡è¨Š -->
        <main id="tab-contacts" class="hidden px-4 py-6">
            <h2 class="text-xl font-bold text-wedding-red mb-4 pl-2 border-l-4 border-wedding-gold">å·¥ä½œäººå“¡é€šè¨ŠéŒ„</h2>
            <div class="grid gap-4" id="contactsContainer"></div>
        </main>

        <!-- TAB 3: å©šç¦®æµç¨‹ -->
        <main id="tab-timeline" class="hidden px-4 py-6">
            <h2 class="text-xl font-bold text-wedding-red mb-6 pl-2 border-l-4 border-wedding-gold">å©šç¦®ç•¶æ—¥æµç¨‹</h2>
            <p class="text-xs text-gray-400 mb-4 pl-2">æ—¥æœŸ: JAN 04</p>
            <div class="bg-white rounded-3xl p-6 shadow-card relative overflow-hidden">
                <div class="timeline-line"></div>
                <div id="timelineContainer"></div>
            </div>
        </main>

        <!-- TAB 4: è»Šç‰Œç³»çµ± -->
        <main id="tab-parking" class="hidden px-4 py-6">
             <div class="flex justify-between items-center mb-6">
                <h2 class="text-xl font-bold text-wedding-red pl-2 border-l-4 border-wedding-gold">å·¥ä½œäººå“¡è»Šç‰Œ</h2>
                <button onclick="openCarModal()" class="text-sm bg-wedding-red text-white px-4 py-2 rounded-full shadow-lg shadow-wedding-red/30 active:scale-95 transition-transform flex items-center">
                    <i class="fas fa-plus mr-1"></i> æ–°å¢
                </button>
            </div>
            <div id="carList" class="space-y-3"></div>
        </main>

        <!-- TAB 6: éº»é›€è¨ˆç•ª -->
        <main id="tab-mahjong" class="hidden px-4 py-6">
            <div class="flex items-center justify-between mb-6">
                <h2 class="text-xl font-bold text-wedding-red pl-2 border-l-4 border-wedding-gold">å»£æ±éº»é›€è¨ˆç•ª</h2>
                <button onclick="resetMahjong()" class="text-xs bg-gray-100 text-gray-500 px-3 py-1.5 rounded-full font-bold">
                    <i class="fas fa-redo-alt mr-1"></i> é‡ç½®
                </button>
            </div>

            <!-- Total Score Display -->
            <div class="bg-gradient-to-br from-wedding-red to-wedding-darkRed rounded-3xl p-6 text-white shadow-xl mb-6 flex flex-col items-center justify-center relative overflow-hidden">
                <div class="absolute inset-0 opacity-10" style="background-image: url('https://www.transparenttextures.com/patterns/black-linen.png');"></div>
                <div class="absolute -right-4 -top-4 text-white/10 text-8xl transform rotate-12">
                    <i class="fas fa-dice"></i>
                </div>
                <div class="relative z-10 text-center">
                    <div class="text-sm text-wedding-gold font-bold uppercase tracking-widest mb-1">Total Fan</div>
                    <div class="text-7xl font-bold" id="totalFanDisplay">0</div>
                    <div class="text-sm opacity-80 mt-2 font-medium">ç•ª</div>
                </div>
            </div>

            <!-- Counters -->
            <div class="bg-white rounded-2xl shadow-sm border border-gray-100 p-4 mb-4">
                <h3 class="text-sm font-bold text-gray-400 uppercase mb-3">åº•åˆ† / ç´¯è¨ˆ</h3>
                <div class="space-y-4">
                    <div class="flex items-center justify-between">
                        <span class="font-bold text-gray-700">èŠ±ç‰Œ (éš»æ•¸)</span>
                        <div class="flex items-center gap-3">
                            <button onclick="updateMjCount('flower', -1)" class="w-8 h-8 rounded-full bg-gray-100 text-gray-500 flex items-center justify-center hover:bg-gray-200"><i class="fas fa-minus"></i></button>
                            <span class="font-bold text-xl w-6 text-center" id="mj-flower-count">0</span>
                            <button onclick="updateMjCount('flower', 1)" class="w-8 h-8 rounded-full bg-wedding-red text-white flex items-center justify-center shadow-lg shadow-wedding-red/30"><i class="fas fa-plus"></i></button>
                        </div>
                    </div>
                    <div class="flex items-center justify-between">
                        <span class="font-bold text-gray-700">é¢¨ç‰Œ/ç®­ç‰Œ (åˆ»å­)</span>
                        <div class="flex items-center gap-3">
                            <button onclick="updateMjCount('honor', -1)" class="w-8 h-8 rounded-full bg-gray-100 text-gray-500 flex items-center justify-center hover:bg-gray-200"><i class="fas fa-minus"></i></button>
                            <span class="font-bold text-xl w-6 text-center" id="mj-honor-count">0</span>
                            <button onclick="updateMjCount('honor', 1)" class="w-8 h-8 rounded-full bg-wedding-red text-white flex items-center justify-center shadow-lg shadow-wedding-red/30"><i class="fas fa-plus"></i></button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Toggles Grid -->
            <div class="grid grid-cols-2 gap-3 mb-6">
                <!-- 1 Fan -->
                <button onclick="toggleMjFan(this, 1)" class="mj-toggle bg-white border border-gray-200 p-3 rounded-xl flex flex-col items-center justify-center transition-all active:scale-95">
                    <span class="font-bold text-lg">è‡ªæ‘¸</span>
                    <span class="text-[10px] text-gray-400 sub-text">+1ç•ª</span>
                </button>
                <button onclick="toggleMjFan(this, 1)" class="mj-toggle bg-white border border-gray-200 p-3 rounded-xl flex flex-col items-center justify-center transition-all active:scale-95">
                    <span class="font-bold text-lg">ç„¡èŠ±</span>
                    <span class="text-[10px] text-gray-400 sub-text">+1ç•ª</span>
                </button>
                <button onclick="toggleMjFan(this, 1)" class="mj-toggle bg-white border border-gray-200 p-3 rounded-xl flex flex-col items-center justify-center transition-all active:scale-95">
                    <span class="font-bold text-lg">é–€å‰æ¸…</span>
                    <span class="text-[10px] text-gray-400 sub-text">+1ç•ª</span>
                </button>
                <button onclick="toggleMjFan(this, 1)" class="mj-toggle bg-white border border-gray-200 p-3 rounded-xl flex flex-col items-center justify-center transition-all active:scale-95">
                    <span class="font-bold text-lg">å¹³èƒ¡</span>
                    <span class="text-[10px] text-gray-400 sub-text">+1ç•ª</span>
                </button>

                <!-- 3 Fan -->
                <button onclick="toggleMjFan(this, 3)" class="mj-toggle bg-white border border-gray-200 p-3 rounded-xl flex flex-col items-center justify-center transition-all active:scale-95">
                    <span class="font-bold text-lg">å°å°ç³Š</span>
                    <span class="text-[10px] text-gray-400 sub-text">+3ç•ª</span>
                </button>
                <button onclick="toggleMjFan(this, 3)" class="mj-toggle bg-white border border-gray-200 p-3 rounded-xl flex flex-col items-center justify-center transition-all active:scale-95">
                    <span class="font-bold text-lg">æ··ä¸€è‰²</span>
                    <span class="text-[10px] text-gray-400 sub-text">+3ç•ª</span>
                </button>

                <!-- High Fan -->
                <button onclick="toggleMjFan(this, 5)" class="mj-toggle bg-white border border-gray-200 p-3 rounded-xl flex flex-col items-center justify-center transition-all active:scale-95">
                    <span class="font-bold text-lg">å°ä¸‰å…ƒ</span>
                    <span class="text-[10px] text-gray-400 sub-text">+5ç•ª</span>
                </button>
                <button onclick="toggleMjFan(this, 7)" class="mj-toggle bg-white border border-gray-200 p-3 rounded-xl flex flex-col items-center justify-center transition-all active:scale-95">
                    <span class="font-bold text-lg">æ¸…ä¸€è‰²</span>
                    <span class="text-[10px] text-gray-400 sub-text">+7ç•ª</span>
                </button>
            </div>
             <p class="text-center text-xs text-gray-400">ç¥å¤§å®¶æ——é–‹å¾—å‹ï¼ğŸ§§</p>
        </main>

        <!-- TAB 5: è³‡è¨Š -->
        <main id="tab-info" class="hidden px-4 py-6">
             <!-- å¤©æ°£ Widget -->
            <div class="bg-gradient-to-br from-blue-400 to-blue-600 rounded-3xl p-6 text-white shadow-lg mb-8 relative overflow-hidden">
                <div class="absolute top-[-20px] right-[-20px] text-white/20 text-9xl">
                    <i class="fas fa-cloud-sun"></i>
                </div>
                <div class="relative z-10">
                    <h3 class="text-sm font-bold uppercase tracking-wider mb-1 opacity-90">å©šç¦®ç•¶æ—¥å¤©æ°£é å ±</h3>
                    <div class="flex items-end gap-4">
                        <div class="text-5xl font-bold">24Â°</div>
                        <div class="mb-2 text-lg font-medium">å¤šé›²æ™‚æ™´</div>
                    </div>
                    <div class="mt-4 flex gap-4 text-sm opacity-90">
                        <div><i class="fas fa-tint mr-1"></i> æ¿•åº¦ 75%</div>
                        <div><i class="fas fa-wind mr-1"></i> å¾®é¢¨</div>
                    </div>
                </div>
            </div>
            
            <!-- Gemini AI Assistant -->
            <div class="bg-white rounded-3xl shadow-card p-0 mb-8 overflow-hidden border border-purple-100">
                <div class="bg-gradient-to-r from-purple-500 to-indigo-600 p-4 text-white flex justify-between items-center">
                    <div class="flex items-center gap-2">
                        <i class="fas fa-sparkles"></i>
                        <h3 class="font-bold">AI å©šç¦®é¡§å•</h3>
                    </div>
                </div>
                <div id="chatHistory" class="p-4 h-48 overflow-y-auto bg-gray-50 flex flex-col gap-2">
                    <div class="chat-bubble ai">æ‚¨å¥½ï¼æˆ‘æ˜¯æ‚¨çš„å©šç¦® AI åŠ©æ‰‹ã€‚é—œæ–¼æµç¨‹ã€è‡´è©æˆ–æ‡‰æ€¥æ–¹æ¡ˆï¼Œéš¨æ™‚å•æˆ‘ï¼âœ¨</div>
                </div>
                <div class="p-3 border-t border-gray-100 flex gap-2 bg-white">
                    <input type="text" id="aiInput" placeholder="ä¾‹å¦‚: æ•¬èŒ¶æœ‰ä»€éº¼å‰åˆ©è©±?" class="flex-1 bg-gray-100 rounded-full px-4 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-purple-200">
                    <button onclick="sendToGemini()" class="w-10 h-10 bg-purple-600 text-white rounded-full flex items-center justify-center hover:bg-purple-700 transition-colors">
                        <i class="fas fa-paper-plane text-xs"></i>
                    </button>
                </div>
            </div>
        </main>
    </div>

    <!-- Bottom Navigation Bar (Fixed - Added Mahjong) -->
    <nav class="fixed bottom-0 left-0 w-full bg-white/95 backdrop-blur-lg border-t border-gray-200 pb-safe pt-1 px-1 flex justify-around items-center z-40 shadow-[0_-5px_20px_rgba(0,0,0,0.05)] h-[80px]">
        <button onclick="switchTab('guests')" class="nav-item active flex-1 min-w-0 flex flex-col items-center justify-center h-full text-gray-400 transition-all duration-300">
            <i class="fas fa-users text-lg mb-1"></i>
            <span class="text-[9px] font-bold">è³“å®¢</span>
        </button>
        
        <button onclick="switchTab('contacts')" class="nav-item flex-1 min-w-0 flex flex-col items-center justify-center h-full text-gray-400 transition-all duration-300">
            <i class="fas fa-address-book text-lg mb-1"></i>
            <span class="text-[9px] font-bold">è¯çµ¡</span>
        </button>

        <button onclick="switchTab('timeline')" class="nav-item flex-1 min-w-0 flex flex-col items-center justify-center h-full text-gray-400 transition-all duration-300">
            <i class="fas fa-clock text-lg mb-1"></i>
            <span class="text-[9px] font-bold">æµç¨‹</span>
        </button>

        <button onclick="switchTab('parking')" class="nav-item flex-1 min-w-0 flex flex-col items-center justify-center h-full text-gray-400 transition-all duration-300">
            <i class="fas fa-car text-lg mb-1"></i>
            <span class="text-[9px] font-bold">è»Šç‰Œ</span>
        </button>

        <button onclick="switchTab('mahjong')" class="nav-item flex-1 min-w-0 flex flex-col items-center justify-center h-full text-gray-400 transition-all duration-300">
            <i class="fas fa-dice text-lg mb-1"></i>
            <span class="text-[9px] font-bold">éº»é›€</span>
        </button>

        <button onclick="switchTab('info')" class="nav-item flex-1 min-w-0 flex flex-col items-center justify-center h-full text-gray-400 transition-all duration-300">
            <i class="fas fa-info-circle text-lg mb-1"></i>
            <span class="text-[9px] font-bold">è³‡è¨Š</span>
        </button>
    </nav>

    <!-- MODALS (Existing Modals) -->
    <!-- 1. Check-in Modal -->
    <div id="checkInModal" class="fixed inset-0 bg-black/70 backdrop-blur-sm hidden items-center justify-center z-50 p-6 opacity-0 transition-opacity duration-300">
        <div class="bg-white w-full max-w-sm rounded-[2rem] shadow-2xl overflow-hidden transform scale-95 transition-transform duration-300 relative flex flex-col" id="checkInContent">
            <button onclick="closeModal('checkInModal')" class="absolute top-4 right-4 z-10 w-8 h-8 bg-gray-100 rounded-full flex items-center justify-center text-gray-500 hover:bg-gray-200">
                <i class="fas fa-times"></i>
            </button>
            <div class="h-32 bg-gradient-to-br from-wedding-red to-wedding-darkRed relative flex items-center justify-center overflow-hidden shrink-0">
                <div class="absolute inset-0 opacity-10" style="background-image: url('https://www.transparenttextures.com/patterns/black-linen.png');"></div>
                <div class="absolute -bottom-8 w-20 h-20 bg-white rounded-full p-1.5 shadow-lg z-10">
                    <div class="w-full h-full bg-gray-100 rounded-full flex items-center justify-center text-3xl font-bold text-wedding-red" id="modalAvatar">
                        <i class="fas fa-user"></i>
                    </div>
                </div>
            </div>
            <div class="pt-12 pb-8 px-6 text-center flex-1 flex flex-col">
                <h2 class="text-2xl font-bold text-gray-800 mb-1" id="modalGuestName">Guest Name</h2>
                <p class="text-sm text-gray-500 mb-4 font-medium" id="modalGuestTable">Table X</p>
                <div id="noInvitationAlert" class="hidden mb-4 bg-red-50 border-l-4 border-wedding-red rounded-r-xl p-4 shadow-sm animate-pulse">
                    <div class="flex flex-col items-center justify-center text-wedding-red">
                        <div class="flex items-center gap-2 mb-2">
                            <i class="fas fa-envelope text-xl"></i>
                            <span class="font-bold text-lg">è«‹è½‰äº¤å–œå¸–ä¸€å¼µ</span>
                        </div>
                        <div class="flex items-center gap-2 bg-white px-3 py-2 rounded-lg border border-red-100 shadow-sm w-full justify-center">
                            <input type="checkbox" id="invitationCheck" class="w-5 h-5 text-wedding-red rounded focus:ring-wedding-red" onchange="toggleConfirmButton()">
                            <label for="invitationCheck" class="text-sm font-bold text-gray-700 cursor-pointer select-none">æˆ‘å·²è½‰äº¤å–œå¸–</label>
                        </div>
                    </div>
                </div>
                <div id="hasInvitationBadge" class="hidden mb-6">
                    <div class="inline-flex items-center gap-2 bg-green-100 text-green-700 px-4 py-2 rounded-full font-bold text-sm border border-green-200 shadow-sm">
                        <i class="fas fa-check-circle text-green-600"></i>
                        <span>å·²é ˜å–å–œå¸–</span>
                    </div>
                </div>
                <div class="grid grid-cols-2 gap-3 mb-8">
                    <div class="bg-gray-50 rounded-xl p-3 border border-gray-100">
                        <div class="text-xs text-gray-400 uppercase font-bold tracking-wider">äººæ•¸</div>
                        <div class="text-xl font-bold text-gray-800" id="modalGuestSize">1</div>
                    </div>
                    <div class="bg-gray-50 rounded-xl p-3 border border-gray-100">
                        <div class="text-xs text-gray-400 uppercase font-bold tracking-wider">ç‹€æ…‹</div>
                        <div class="text-xl font-bold" id="modalStatusText">æœªç°½åˆ°</div>
                    </div>
                </div>
                <button id="checkInBtn" onclick="toggleCheckIn()" class="w-full py-4 rounded-xl font-bold text-lg shadow-lg transform transition-all active:scale-95 flex items-center justify-center gap-2 mt-auto disabled:opacity-50 disabled:cursor-not-allowed">
                    <!-- Icon & Text injected by JS -->
                </button>
            </div>
        </div>
    </div>

    <!-- 2. Car Info Modal -->
    <div id="carModal" class="fixed inset-0 bg-black/70 backdrop-blur-sm hidden items-center justify-center z-50 p-6 opacity-0 transition-opacity duration-300">
        <div class="bg-white w-full max-w-sm rounded-[2rem] shadow-2xl p-6 transform scale-95 transition-transform duration-300" id="carModalContent">
            <h3 class="text-xl font-bold text-gray-800 mb-4 text-center">æ–°å¢è»Šç‰Œ</h3>
            <form id="carForm" onsubmit="saveCarInfo(event)">
                <div class="space-y-4">
                    <div>
                        <label class="block text-xs font-bold text-gray-400 uppercase mb-1">å§“å</label>
                        <input type="text" id="carOwner" required class="w-full bg-gray-50 border-none rounded-xl px-4 py-3 text-gray-800 font-medium focus:ring-2 focus:ring-wedding-gold/50" placeholder="ä¾‹å¦‚: Dicky">
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-gray-400 uppercase mb-1">è»Šç‰Œè™Ÿç¢¼</label>
                        <input type="text" id="carPlate" required class="w-full bg-gray-50 border-none rounded-xl px-4 py-3 text-gray-800 font-bold focus:ring-2 focus:ring-wedding-gold/50" placeholder="ä¾‹å¦‚: WN3564">
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-gray-400 uppercase mb-1">é è¨ˆåœæ³Šæ™‚é–“ (éå¿…å¡«)</label>
                        <input type="text" id="carTime" class="w-full bg-gray-50 border-none rounded-xl px-4 py-3 text-gray-800 font-medium focus:ring-2 focus:ring-wedding-gold/50" placeholder="ä¾‹å¦‚: 14:00 - 23:00">
                    </div>
                </div>
                <div class="mt-6 flex gap-3">
                    <button type="button" onclick="closeModal('carModal')" class="flex-1 py-3 rounded-xl bg-gray-100 text-gray-500 font-bold">å–æ¶ˆ</button>
                    <button type="submit" class="flex-1 py-3 rounded-xl bg-wedding-red text-white font-bold shadow-lg shadow-wedding-red/30">å„²å­˜</button>
                </div>
            </form>
        </div>
    </div>

    <!-- 3. Image Viewer Modal -->
    <div id="imageModal" class="fixed inset-0 bg-black/90 hidden items-center justify-center z-[60] p-0" onclick="closeModal('imageModal')">
        <img id="fullImage" src="" class="max-w-full max-h-full object-contain" alt="Full Screen Image">
        <button class="absolute top-4 right-4 text-white/70 hover:text-white text-3xl">
            <i class="fas fa-times"></i>
        </button>
    </div>

    <script>
        const apiKey = "";
        const TABLE_COUNT = 19; 
        const SEATS_PER_TABLE = 12;
        
        const TABLE_INFO = {
            1: { title: "ä¸»å®¶å¸­", color: "gold" },
            2: { title: "ç”·å®¶é•·è¼©", color: "red" },
            3: { title: "å¥³å®¶é•·è¼©", color: "red" },
            5: { title: "å¥³å®¶è¦ªæˆš", color: "pink" },
            6: { title: "ç”·å®¶æœ‹å‹", color: "blue" },
            7: { title: "ç”·å®¶æœ‹å‹", color: "blue" },
            8: { title: "å¥³å®¶è¦ªæˆš", color: "pink" },
            9: { title: "å¥³å®¶æœ‹å‹", color: "pink" },
            10: { title: "ç”·å®¶æœ‹å‹", color: "blue" },
            11: { title: "ç”·å®¶æœ‹å‹", color: "blue" },
            12: { title: "å¥³å®¶æœ‹å‹", color: "pink" },
            13: { title: "å¥³å®¶æœ‹å‹", color: "pink" },
            15: { title: "ç”·å®¶æœ‹å‹", color: "blue" },
            16: { title: "ç”·å®¶æœ‹å‹", color: "blue" },
            17: { title: "å¥³å®¶æœ‹å‹", color: "pink" },
            18: { title: "ç”·å®¶æœ‹å‹", color: "blue" },
            19: { title: "ç”·å®¶æœ‹å‹", color: "blue" }
        };

        // Guest List (Truncated for brevity, but logically full)
        let rawGuests = [
            // Table 1
            { name: "æ–°éƒåª½åª½", tableId: 1, hasInvitation: true },
            { name: "æ–°éƒå§¨ä¸ˆ(+æ–°éƒå§¨åª½,æ–°éƒè¡¨å“¥,æ–°éƒè¡¨å§)", tableId: 1, manualSize: 4, hasInvitation: false },
            { name: "å³ç”Ÿ(Mr Roger Ng)+å³å¤ª(Ms Amy Leung)", tableId: 1, manualSize: 2, hasInvitation: true },
            { name: "æ–°éƒè¡¨å§¨(Shirley Hui)(+è¡¨å§¨ä¸ˆ)", tableId: 1, manualSize: 2, hasInvitation: false },
            { name: "æ–°éƒå¤§èˆ…çˆ¶ (Steven Hui) (+èˆ…æ¯)", tableId: 1, manualSize: 2, hasInvitation: false },
            { name: "æ–°éƒèˆ…çˆ¶(Stanley Hui) (+èˆ…æ¯)", tableId: 1, manualSize: 2, hasInvitation: false },
            { name: "èƒ¡ç”Ÿ(+è¨±å°å§+èƒ¡è¶…æ–‡)", tableId: 1, manualSize: 3, hasInvitation: false },
            { name: "æ°¸é«˜è€å”(+è€å¬¸)", tableId: 1, manualSize: 2, hasInvitation: true },
            { name: "æ–°éƒ", tableId: 1, hasInvitation: true },
            { name: "æ–°å¨˜", tableId: 1, hasInvitation: true },
            // Table 2
            { name: "æ–‡æ˜­èˆ…èˆ…(+èˆ…æ¯)", tableId: 2, manualSize: 2, hasInvitation: false },
            { name: "ç‚¯å¼ºèˆ…èˆ…(+èˆ…æ¯)", tableId: 2, manualSize: 2, hasInvitation: false },
            { name: "è€€å½¬èˆ…èˆ…(+èˆ…æ¯)", tableId: 2, manualSize: 2, hasInvitation: false },
            { name: "åŸºèŒ‚èˆ…èˆ…", tableId: 2, hasInvitation: false },
            { name: "ç››å°‘è‹±(+æ—å…ˆç”Ÿ)", tableId: 2, manualSize: 2, hasInvitation: false },
            { name: "åŠ‰åŠæ–‡(+åŠ‰å¤ª)", tableId: 2, manualSize: 2, hasInvitation: false },
            // Table 3
            { name: "æ–°å¨˜çˆ¸çˆ¸", tableId: 3, hasInvitation: true }, 
            { name: "æ–°å¨˜åª½åª½", tableId: 3, hasInvitation: true }, 
            { name: "æ–°å¨˜å«²å«²", tableId: 3, hasInvitation: true },
            { name: "æ–°å¨˜å¤–å…¬", tableId: 3, hasInvitation: true }, 
            { name: "å€©å…’å§¨å©†", tableId: 3, hasInvitation: true }, { name: "éŒ«ç”Ÿèˆ…å…¬", tableId: 3, hasInvitation: true },
            { name: "éº—å…’å§¨å©†", tableId: 3, hasInvitation: true }, { name: "ç‡•å…’å§¨å©†", tableId: 3, hasInvitation: true }, 
            { name: "å¤©è™¹å§‘å©†", tableId: 3, hasInvitation: true }, { name: "æ›‰è™¹å§‘å©†", tableId: 3, hasInvitation: true }, 
            { name: "å€æ¸…å§¨å©†", tableId: 3, hasInvitation: true }, { name: "æ¢…å†°å§¨å…¬", tableId: 3, hasInvitation: true },
            // Table 5
            { name: "å¾å‰èˆ…èˆ…", tableId: 5, hasInvitation: false }, { name: "Reiki", tableId: 5, hasInvitation: false }, 
            { name: "å‚…å…ˆç”Ÿå…¨å®¶(+5ä½)", tableId: 5, manualSize: 6, hasInvitation: false },
            { name: "ç‹å‘ç´…", tableId: 5, hasInvitation: false }, 
            { name: "å³æ‰¿èŠ", tableId: 5, hasInvitation: false }, 
            { name: "å³èµ·æ•", tableId: 5, hasInvitation: false },
            // Table 6
            { name: "ç¶ºè¯", tableId: 6, hasInvitation: false }, { name: "éŒ¦é‘¾", tableId: 6, hasInvitation: false }, 
            { name: "ä½©è¯", tableId: 6, hasInvitation: false }, { name: "æ·‘è¯", tableId: 6, hasInvitation: false }, 
            { name: "å®‹åŸ", tableId: 6, hasInvitation: false }, { name: "ç‡•èŠ¬", tableId: 6, hasInvitation: false },
            { name: "ç‰å¨¥", tableId: 6, hasInvitation: false }, { name: "å§šæ™´è±", tableId: 6, hasInvitation: false }, 
            { name: "å§šæ¾¤å½¬", tableId: 6, hasInvitation: false }, { name: "åŠ‰å­éˆ(+3ä½)", tableId: 6, manualSize: 4, hasInvitation: false },
            // Table 7
            { name: "å³æ€»", tableId: 7, hasInvitation: false }, { name: "Carly Ng", tableId: 7, hasInvitation: false }, 
            { name: "å¾ç”Ÿ", tableId: 7, hasInvitation: false }, { name: "Stephanus (+4)", tableId: 7, manualSize: 5, hasInvitation: false },
            { name: "Roberto (+1)", tableId: 7, manualSize: 2, hasInvitation: false },
            { name: "å¾ç¸½", tableId: 7, hasInvitation: true }, 
            { name: "Jimmy", tableId: 7, hasInvitation: true },
            // Table 8
            { name: "æ¢…å£«å¹³å”å”", tableId: 8, hasInvitation: false }, { name: "ç‡•è¯å¬¸å¬¸", tableId: 8, hasInvitation: false }, 
            { name: "çŸéµå§‘å§", tableId: 8, hasInvitation: false }, { name: "æµ·æ­å”å”", tableId: 8, hasInvitation: false }, 
            { name: "é»ƒæ²›ç‘œ", tableId: 8, hasInvitation: false }, 
            { name: "é»ƒæµ·æ´‹(+1ä½)", tableId: 8, manualSize: 2, hasInvitation: false }, 
            { name: "æ–Œæ¯…èˆ…èˆ…å…¨å®¶(+2ä½)", tableId: 8, manualSize: 3, hasInvitation: false }, 
            { name: "Alex Wong", tableId: 8, hasInvitation: false }, { name: "Jack Wong", tableId: 8, hasInvitation: false },
            // Table 9
            { name: "Leila", tableId: 9, hasInvitation: false }, { name: "Ana", tableId: 9, hasInvitation: false }, 
            { name: "Gavin", tableId: 9, hasInvitation: false }, { name: "Davina", tableId: 9, hasInvitation: false }, 
            { name: "Catherine", tableId: 9, hasInvitation: false }, { name: "Lemon", tableId: 9, hasInvitation: false },
            { name: "Nora", tableId: 9, hasInvitation: false }, { name: "Brian", tableId: 9, hasInvitation: false }, 
            { name: "Kiki", tableId: 9, hasInvitation: false }, { name: "Jorie", tableId: 9, hasInvitation: false }, 
            { name: "Yichen", tableId: 9, hasInvitation: false }, { name: "Katia", tableId: 9, hasInvitation: false },
            // Table 10
            { name: "å¤§çœ¼ä»”2", tableId: 10, manualSize: 2, hasInvitation: false }, 
            { name: "Ng Ming Kin(+3ä½)", tableId: 10, manualSize: 4, hasInvitation: false }, 
            { name: "Sunkist Sit", tableId: 10, hasInvitation: false },
            { name: "é™³å‡±å‰", tableId: 10, hasInvitation: true }, 
            { name: "é»ƒåœ‹ç¿¹(+1ä½)", tableId: 10, manualSize: 2, hasInvitation: false }, 
            { name: "æ–¹é½Šç™¼(+1ä½)", tableId: 10, manualSize: 2, hasInvitation: false },
            // Table 11
            { name: "Sammi", tableId: 11, hasInvitation: true }, { name: "Crystal", tableId: 11, hasInvitation: true }, 
            { name: "Michelle", tableId: 11, hasInvitation: true }, { name: "Joe Lo", tableId: 11, hasInvitation: true }, 
            { name: "Winky Chau", tableId: 11, hasInvitation: false }, 
            { name: "é„­åœ‹é˜(+3ä½)", tableId: 11, manualSize: 4, hasInvitation: false },
            { name: "Kathy Keh", tableId: 11, hasInvitation: false }, { name: "Kayleen Keh", tableId: 11, hasInvitation: false }, 
            { name: "Miyuki sze", tableId: 11, hasInvitation: false },
            // Table 12
            { name: "Phoebe", tableId: 12, hasInvitation: false }, { name: "Tingting", tableId: 12, hasInvitation: false }, 
            { name: "Darren", tableId: 12, hasInvitation: false }, { name: "Chris", tableId: 12, hasInvitation: false }, 
            { name: "Siann", tableId: 12, hasInvitation: false }, { name: "Miror", tableId: 12, hasInvitation: false },
            { name: "KC", tableId: 12, hasInvitation: false }, { name: "Brian", tableId: 12, hasInvitation: false }, 
            { name: "Wilson", tableId: 12, hasInvitation: false }, { name: "Andy", tableId: 12, hasInvitation: false }, 
            { name: "Anthony", tableId: 12, hasInvitation: false }, { name: "justin", tableId: 12, hasInvitation: false },
            // Table 13
            { name: "Kelly(+3ä½)", tableId: 13, manualSize: 4, hasInvitation: false }, 
            { name: "Lancy", tableId: 13, hasInvitation: false }, { name: "Betty", tableId: 13, hasInvitation: false }, 
            { name: "Lauren (+1ä½)", tableId: 13, manualSize: 2, hasInvitation: false }, 
            { name: "Linda Pak (+2ä½)", tableId: 13, manualSize: 3, hasInvitation: false },
            // Table 15
            { name: "Jason Wong", tableId: 15, hasInvitation: true }, { name: "Wiliam Wong", tableId: 15, hasInvitation: true }, 
            { name: "James Lo", tableId: 15, hasInvitation: true }, { name: "Nik Po", tableId: 15, hasInvitation: true }, 
            { name: "æ—éœ", tableId: 15, hasInvitation: true }, { name: "å‡Œç”Ÿ", tableId: 15, hasInvitation: true },
            { name: "å¼µå¤©æ°¸", tableId: 15, hasInvitation: false }, 
            { name: "æ—ç”Ÿ(2ä½)", tableId: 15, manualSize: 2, hasInvitation: true }, 
            { name: "åŠ‰æ€»", tableId: 15, hasInvitation: true },
            { name: "Sanda Tsang", tableId: 15, hasInvitation: true }, { name: "Lala", tableId: 15, hasInvitation: true },
            // Table 16
            { name: "æš¢(å…’å­)", tableId: 16, hasInvitation: false }, { name: "è‘‰å ¡ç›", tableId: 16, hasInvitation: false }, 
            { name: "åŠ‰å­è»’(3ä½)", tableId: 16, manualSize: 3, hasInvitation: false },
            { name: "æ—ç¶ºå©·", tableId: 16, hasInvitation: false }, { name: "æœ±å²¸å—", tableId: 16, hasInvitation: false }, 
            { name: "Dicky Cheung", tableId: 16, hasInvitation: false }, { name: "Karen Law", tableId: 16, hasInvitation: false }, 
            { name: "èŒƒå˜‰ä¿Š", tableId: 16, hasInvitation: false }, { name: "ä»»æ—­é™½", tableId: 16, hasInvitation: false },
            { name: "Rannie Yu", tableId: 16, hasInvitation: true }, 
            // Table 17
            { name: "Denise", tableId: 17, hasInvitation: false }, { name: "Leo", tableId: 17, hasInvitation: false }, 
            { name: "Gloria", tableId: 17, hasInvitation: false }, { name: "Mackie", tableId: 17, hasInvitation: false }, 
            { name: "Brina", tableId: 17, hasInvitation: false }, { name: "Ashley", tableId: 17, hasInvitation: false },
            { name: "Shiiko", tableId: 17, hasInvitation: false }, { name: "Jaye", tableId: 17, hasInvitation: false }, 
            { name: "Cheryl", tableId: 17, hasInvitation: false }, { name: "Betsy", tableId: 17, hasInvitation: false }, 
            { name: "Joe", tableId: 17, hasInvitation: false }, { name: "Pakki", tableId: 17, hasInvitation: false },
            // Table 18
            { name: "Crystal", tableId: 18, hasInvitation: false }, { name: "Ada", tableId: 18, hasInvitation: false }, 
            { name: "Angel", tableId: 18, hasInvitation: false }, { name: "Celia", tableId: 18, hasInvitation: false }, 
            { name: "Siu Yuk", tableId: 18, hasInvitation: false }, { name: "Momoco", tableId: 18, hasInvitation: false },
            { name: "Alison", tableId: 18, hasInvitation: false }, { name: "é™³å˜‰å®‰", tableId: 18, hasInvitation: false }, 
            { name: "John", tableId: 18, hasInvitation: false }, { name: "Or fu", tableId: 18, hasInvitation: false },
            // Table 19
            { name: "Kelvin Li", tableId: 19, hasInvitation: true }, { name: "Matt", tableId: 19, hasInvitation: true }, 
            { name: "Hayley", tableId: 19, hasInvitation: true }, { name: "Ivy", tableId: 19, hasInvitation: true }, 
            { name: "Ting fung", tableId: 19, hasInvitation: true }, { name: "Roxanne", tableId: 19, hasInvitation: true },
            { name: "Gigi", tableId: 19, hasInvitation: true }, { name: "Bonnie", tableId: 19, hasInvitation: true }, 
            { name: "Vicky", tableId: 19, hasInvitation: true }, { name: "Moon", tableId: 19, hasInvitation: true }, 
            { name: "Sandra", tableId: 19, hasInvitation: true }, { name: "Cling", tableId: 19, hasInvitation: true },
        ];

        // Contact Data
        const contacts = [
            { role: "é…’åº—è² è²¬äºº", name: "Sharon", phone: "+85297434761" },
            { role: "æ–°å¨˜", name: "Shirley", phone: "+85265063298" },
            { role: "æ–°éƒ", name: "Oscar", phone: "+85265752256" },
            { role: "åŒ–å¦å¸«", name: "MUA", phone: "+85261603653" },
            { role: "é«®å‹å¸«", name: "Stylist", phone: "+85269737622" },
            { role: "æ”å½±å¸«", name: "Photog 1", phone: "+8529563564" },
            { role: "æ”å½±å¸«", name: "Photog 2", phone: "+85292642380" },
            { role: "å§Šå¦¹", name: "Sandra", phone: "+85266217286" },
            { role: "å§Šå¦¹", name: "Roxanne", phone: "+85291982178" },
            { role: "å§Šå¦¹", name: "TF", phone: "+85260278536" }
        ];

        // Default Car Data
        const defaultCars = [
            { owner: "Dicky", plate: "WN3564", time: "å…¨æ—¥" },
            { owner: "Ngâ€™s", plate: "NG7879", time: "å…¨æ—¥" },
            { owner: "Scott", plate: "YM4955", time: "å…¨æ—¥" }
        ];

        // Timeline Data
        const timelineData = [
            { time: "05:00:00", event: "Make up get ready", location: "" },
            { time: "06:00:00", event: "é«®å‹å¸«ä¸Šæˆ¿", location: "" },
            { time: "06:30:00", event: "Everyone stand by", location: "" },
            { time: "07:00:00", event: "Photo time", location: "Bride + Bridemates+ Bride Mum" },
            { time: "08:00:00", event: "Groom to pick up the Bride", location: "" },
            { time: "08:20", event: "æ„›çš„å®£è¨€ + Photo time", location: "Hotel room (Upstairs)" },
            { time: "08:30 - 09:00", event: "Tea time (Bride's relatives)", location: "Hotel room (Upstairs)" },
            { time: "09:10:00", event: "Tea time (Groom's relatives)", location: "G/F Tea room (Near to the ballroom)" },
            { time: "09:50-10:00", event: "Lawyer 10 mins", location: "Tea room" },
            { time: "10:00-10:30", event: "Change clothes", location: "down stairs changing room" },
            { time: "10:30-11:00", event: "Photo time at restaurant", location: "QURA" },
            { time: "11:00-12:00", event: "Reception time", location: "" },
            { time: "12:00-12:30", event: "Change clothes", location: "Changing room" },
            { time: "12:30:00", event: "Video 1 (å©šç¦®é–‹å ´ç‰‡) / MC opening", location: "Ballroom" },
            { time: "12:30:00", event: "Groom & Bride enter / Cut Cake", location: "Ballroom" },
        ];

        let guests = [];
        let carData = [];
        let currentGuestId = null;

        // Mahjong State
        let mjState = {
            flower: 0,
            honor: 0,
            fan: 0
        };

        document.addEventListener('DOMContentLoaded', () => {
            initGuests();
            initContacts();
            initCars();
            initTimeline();
            renderApp();
            setupSearch();
            setupScrollEffect();
            updateSpacerHeight();
        });

        // --- Init Functions ---
        function initGuests() {
            guests = rawGuests.map((g, index) => {
                let size = 1;
                if (g.manualSize) {
                    size = g.manualSize;
                } else {
                    const name = g.name;
                    const plusMatch = name.match(/\(\+(\d+)(?:ä½|äºº)?\)/);
                    if (plusMatch) size = 1 + parseInt(plusMatch[1]);
                    const bracketMatch = name.match(/\((\d+)[ä½äºº]\)/);
                    if (bracketMatch) size = parseInt(bracketMatch[1]);
                    const spaceNumMatch = name.match(/\s(\d+)$/);
                    if (spaceNumMatch) size = parseInt(spaceNumMatch[1]);
                    if (name.includes("ä¼‰å„·") && !plusMatch && !bracketMatch) size = 2;
                }
                return {
                    id: index + 1,
                    name: g.name,
                    tableId: g.tableId,
                    size: size,
                    checkedIn: false,
                    hasInvitation: g.hasInvitation === true 
                };
            });
        }

        function initContacts() {
            const container = document.getElementById('contactsContainer');
            container.innerHTML = contacts.map(c => `
                <div class="contact-card bg-white p-4 rounded-2xl shadow-sm border border-gray-100 flex items-center justify-between transition-transform">
                    <div class="flex items-center gap-4">
                        <div class="w-10 h-10 rounded-full bg-wedding-pink text-wedding-red flex items-center justify-center font-bold text-sm">
                            ${c.role.substring(0, 1)}
                        </div>
                        <div>
                            <div class="font-bold text-gray-800">${c.name}</div>
                            <div class="text-xs text-gray-500">${c.role}</div>
                        </div>
                    </div>
                    <a href="https://wa.me/${c.phone.replace(/[^0-9]/g, '')}" target="_blank" class="bg-[#25D366] text-white w-10 h-10 rounded-full flex items-center justify-center shadow-md active:scale-95 transition-transform">
                        <i class="fab fa-whatsapp text-xl"></i>
                    </a>
                </div>
            `).join('');
        }

        function initTimeline() {
            const container = document.getElementById('timelineContainer');
            container.innerHTML = timelineData.map(item => `
                <div class="timeline-item">
                    <div class="timeline-dot"></div>
                    <div class="timeline-time">${item.time}</div>
                    <div class="text-gray-800 font-bold">${item.event}</div>
                    ${item.location ? `<div class="timeline-location"><i class="fas fa-map-marker-alt"></i> ${item.location}</div>` : ''}
                </div>
            `).join('');
        }

        function initCars() {
            const storedCars = localStorage.getItem('weddingCars');
            if (storedCars) {
                carData = JSON.parse(storedCars);
            } else {
                carData = defaultCars;
                localStorage.setItem('weddingCars', JSON.stringify(carData));
            }
            renderCarList();
        }

        // --- Render Functions ---
        function renderApp() {
            renderStats();
            renderTables();
        }

        function renderStats() {
            const totalHeadcount = guests.reduce((sum, g) => sum + g.size, 0);
            const checkedInHeadcount = guests.filter(g => g.checkedIn).reduce((sum, g) => sum + g.size, 0);
            const pendingHeadcount = totalHeadcount - checkedInHeadcount;

            animateValue("totalHeadcount", parseInt(document.getElementById("totalHeadcount").innerText), totalHeadcount, 500);
            animateValue("checkedInCount", parseInt(document.getElementById("checkedInCount").innerText), checkedInHeadcount, 500);
            document.getElementById('pendingCount').innerText = pendingHeadcount;
            
            if(document.getElementById("totalHeadcount")) document.getElementById("totalHeadcount").innerText = totalHeadcount;
        }

        function renderTables() {
            const container = document.getElementById('tablesContainer');
            container.innerHTML = '';
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();

            for (let i = 1; i <= TABLE_COUNT; i++) {
                if (i === 4 || i === 14) continue;

                let tableGuests = guests.filter(g => g.tableId === i);
                if (searchTerm) {
                    const hasMatch = tableGuests.some(g => g.name.toLowerCase().includes(searchTerm));
                    if (!hasMatch) continue;
                }

                const currentHeadcount = tableGuests.reduce((sum, g) => sum + g.size, 0);
                const isOverCapacity = currentHeadcount > SEATS_PER_TABLE;
                const info = TABLE_INFO[i] || { title: `ç¬¬ ${i} æ¡Œ`, color: 'gray' };
                
                let headerBg, borderColor, titleColor, subTitle, iconBg, iconColor;

                if (info.color === "gold") {
                    headerBg = 'bg-gradient-to-r from-wedding-gold/20 to-white';
                    titleColor = 'text-[#856404]';
                    borderColor = 'border-wedding-gold/40';
                    iconBg = 'bg-wedding-gold/20';
                    iconColor = 'text-[#856404]';
                    subTitle = `<span class="text-xs text-wedding-gold font-bold ml-2">(${info.title})</span>`;
                } else if (info.color === "red") {
                    headerBg = 'bg-gradient-to-r from-wedding-red/10 to-white';
                    titleColor = 'text-wedding-red';
                    borderColor = 'border-wedding-red/20';
                    iconBg = 'bg-wedding-red/10';
                    iconColor = 'text-wedding-red';
                    subTitle = `<span class="text-xs text-wedding-red font-bold ml-2">(${info.title})</span>`;
                } else if (info.color === "blue") {
                    headerBg = 'bg-gradient-to-r from-blue-100 to-white';
                    titleColor = 'text-blue-800';
                    borderColor = 'border-blue-200';
                    iconBg = 'bg-blue-100';
                    iconColor = 'text-blue-600';
                    subTitle = `<span class="text-xs text-blue-600 font-bold ml-2">(${info.title})</span>`;
                } else if (info.color === "pink") {
                    headerBg = 'bg-gradient-to-r from-pink-100 to-white';
                    titleColor = 'text-pink-800';
                    borderColor = 'border-pink-200';
                    iconBg = 'bg-pink-100';
                    iconColor = 'text-pink-600';
                    subTitle = `<span class="text-xs text-pink-600 font-bold ml-2">(${info.title})</span>`;
                } else {
                    headerBg = 'bg-white';
                    titleColor = 'text-gray-800';
                    borderColor = 'border-transparent';
                    iconBg = 'bg-gray-100';
                    iconColor = 'text-gray-400';
                    subTitle = `<span class="text-xs text-gray-400 font-normal ml-2">${info.title}</span>`;
                }

                let cardHTML = `
                    <div class="bg-white/90 backdrop-blur-sm rounded-3xl shadow-card overflow-hidden border-2 ${borderColor} transition-all duration-300 hover:shadow-xl group-hover:border-wedding-gold/30">
                        <div class="p-4 border-b border-gray-100 flex justify-between items-center ${headerBg}">
                            <div class="flex items-center">
                                <div class="w-8 h-8 rounded-full ${iconBg} ${iconColor} flex items-center justify-center font-bold text-sm mr-2">
                                    ${i}
                                </div>
                                <h3 class="font-bold text-lg ${titleColor}">ç¬¬ ${i} æ¡Œ${subTitle}</h3>
                            </div>
                            <span class="text-xs font-bold ${isOverCapacity ? 'text-red-500' : 'text-gray-400'} bg-gray-50 px-2 py-1 rounded-lg">
                                <i class="fas fa-users mr-1"></i> ${currentHeadcount}/${SEATS_PER_TABLE}
                            </span>
                        </div>
                        
                        <div class="p-3 min-h-[80px]">
                            <div class="flex flex-wrap gap-2">
                                ${tableGuests.map(guest => {
                                    const opacityClass = searchTerm && !guest.name.toLowerCase().includes(searchTerm) ? 'opacity-30' : 'opacity-100';
                                    
                                    return `
                                    <div onclick="openCheckInModal(${guest.id})" class="guest-card ${guest.checkedIn ? 'checked-in' : 'bg-gray-50'} ${opacityClass} cursor-pointer group relative border border-gray-100 rounded-xl px-3 py-2 flex items-center transition-all duration-200 hover:scale-105 active:scale-95 w-full sm:w-auto hover:border-wedding-gold/30 hover:shadow-md">
                                        <div class="avatar-box w-8 h-8 rounded-full ${guest.checkedIn ? 'bg-wedding-green text-white' : 'bg-white text-gray-300'} flex items-center justify-center text-xs font-bold mr-3 shadow-sm transition-colors">
                                            ${guest.checkedIn ? '<i class="fas fa-check"></i>' : (guest.size > 1 ? guest.size : '<i class="fas fa-user"></i>')}
                                        </div>
                                        
                                        <div class="flex-1">
                                            <div class="text-sm font-bold text-gray-700 leading-tight flex items-center justify-between">
                                                <span class="${guest.hasInvitation ? 'text-blue-600' : 'text-black'}">${guest.name}</span>
                                            </div>
                                            ${guest.size > 1 ? `<div class="text-[10px] text-gray-400 font-medium">å…± ${guest.size} ä½</div>` : ''}
                                        </div>

                                        ${guest.checkedIn ? '<div class="absolute right-2 top-1/2 transform -translate-y-1/2 text-wedding-green/20 text-4xl -z-0 pointer-events-none"><i class="fas fa-check-circle"></i></div>' : ''}
                                    </div>
                                `}).join('')}
                            </div>
                        </div>
                    </div>
                `;
                container.innerHTML += cardHTML;
            }
        }

        function renderCarList() {
            const list = document.getElementById('carList');
            // Remove delete button from template
            list.innerHTML = carData.map((car, index) => `
                <div class="bg-white p-4 rounded-xl border border-gray-100 shadow-sm flex justify-between items-center group">
                    <div>
                        <div class="font-bold text-gray-800">${car.owner} <span class="text-wedding-red ml-2 bg-wedding-pink px-2 rounded text-xs">${car.plate}</span></div>
                        <div class="text-xs text-gray-500 mt-1"><i class="far fa-clock mr-1"></i> ${car.time || 'å…¨æ—¥'}</div>
                    </div>
                    <!-- Delete button removed -->
                </div>
            `).join('');
        }

        // --- Interaction Logic ---
        function switchTab(tabName) {
            ['guests', 'contacts', 'timeline', 'parking', 'info', 'mahjong'].forEach(t => {
                const el = document.getElementById(`tab-${t}`);
                if(el) el.classList.add('hidden');
            });
            document.getElementById(`tab-${tabName}`).classList.remove('hidden');
            
            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active', 'text-wedding-red'));
            const activeBtn = document.querySelector(`.nav-item[onclick="switchTab('${tabName}')"]`);
            if(activeBtn) activeBtn.classList.add('active', 'text-wedding-red');
            
            // Scroll to top
            window.scrollTo(0,0);
            
            // Re-eval header state after tab switch
            // Use setTimeout to allow DOM to update visibility
            setTimeout(() => {
                updateSpacerHeight();
                // Manually trigger scroll event logic to set correct state
                window.dispatchEvent(new Event('scroll'));
            }, 50);
        }
        
        // --- Sticky Header Logic ---
        function setupScrollEffect() {
            window.addEventListener('scroll', () => {
                const header = document.getElementById('mainHeader');
                const subtitle = document.getElementById('headerSubtitle');
                const divider = document.getElementById('headerDivider');
                const stats = document.getElementById('header-stats');
                const titleWrapper = document.getElementById('headerTitleWrapper');
                const searchBar = document.getElementById('searchBar');
                
                // Check if user has scrolled down
                if (window.scrollY > 30) {
                    // Shrink State
                    header.classList.remove('pt-10', 'pb-8', 'rounded-b-[2.5rem]');
                    header.classList.add('pt-3', 'pb-3', 'rounded-b-3xl', 'shadow-2xl');
                    
                    // Hide Subtitle
                    subtitle.classList.replace('max-h-10', 'max-h-0');
                    subtitle.classList.replace('opacity-100', 'opacity-0');
                    subtitle.classList.replace('mb-2', 'mb-0');
                    
                    // Hide Divider
                    divider.classList.replace('max-h-1', 'max-h-0');
                    divider.classList.replace('opacity-100', 'opacity-0');
                    divider.classList.replace('mt-2', 'mt-0');

                    // Scale Title Down
                    titleWrapper.classList.add('scale-75');
                    
                    // Hide Stats regardless of tab
                    stats.classList.replace('max-h-[100px]', 'max-h-0');
                    stats.classList.replace('opacity-100', 'opacity-0');
                    stats.classList.replace('mt-8', 'mt-0');
                    
                    // Adjust sticky search bar position if visible
                    if(searchBar) {
                        searchBar.style.top = '80px'; // Adjust based on shrunk header height
                    }
                    
                } else {
                    // Expanded State
                    header.classList.add('pt-10', 'pb-8', 'rounded-b-[2.5rem]');
                    header.classList.remove('pt-3', 'pb-3', 'rounded-b-3xl', 'shadow-2xl');

                    // Show Subtitle
                    subtitle.classList.replace('max-h-0', 'max-h-10');
                    subtitle.classList.replace('opacity-0', 'opacity-100');
                    subtitle.classList.replace('mb-0', 'mb-2');

                    // Show Divider
                    divider.classList.replace('max-h-0', 'max-h-1');
                    divider.classList.replace('opacity-0', 'opacity-100');
                    divider.classList.replace('mt-0', 'mt-2');

                    // Reset Title Scale
                    titleWrapper.classList.remove('scale-75');

                    // Show Stats only if on Guests Tab
                    const isGuestTab = !document.getElementById('tab-guests').classList.contains('hidden');
                    if (isGuestTab) {
                        stats.classList.replace('max-h-0', 'max-h-[100px]');
                        stats.classList.replace('opacity-0', 'opacity-100');
                        stats.classList.replace('mt-0', 'mt-8');
                    } else {
                        // Keep stats hidden if not on guest tab
                        stats.classList.replace('max-h-[100px]', 'max-h-0');
                        stats.classList.replace('opacity-100', 'opacity-0');
                        stats.classList.replace('mt-8', 'mt-0');
                    }
                    
                    // Reset sticky search bar position
                    if(searchBar) {
                         searchBar.style.top = '280px'; // Approx expanded height
                         // Better: let it flow naturally or calc height? 
                         // For simplicity, we just clear inline style and let CSS sticky handle (if not fixed)
                         // But since we use sticky top-[x], we need to be careful.
                         // Actually, sticky works relative to viewport. If header is fixed, search bar needs top = header height.
                         // We'll update spacer height logic to handle flow.
                         const headerHeight = header.offsetHeight;
                         searchBar.style.top = (headerHeight + 10) + 'px';
                    }
                }
            });
        }
        
        function updateSpacerHeight() {
            const header = document.getElementById('mainHeader');
            const spacer = document.getElementById('headerSpacer');
            // We want spacer to be the height of the header in its "expanded" state (at top)
            // If we are currently scrolled down, we might not get the full height, 
            // but for initial load or tab switch at top it works.
            if(window.scrollY < 30) {
                 spacer.style.height = header.offsetHeight + 'px';
            }
            // If scrolled, we don't update spacer to prevent content jumping
        }

        function openCheckInModal(id) {
            currentGuestId = id;
            const guest = guests.find(g => g.id === id);
            const modal = document.getElementById('checkInModal');
            const content = document.getElementById('checkInContent');
            const noInvitationAlert = document.getElementById('noInvitationAlert');
            const hasInvitationBadge = document.getElementById('hasInvitationBadge');
            const invitationCheck = document.getElementById('invitationCheck');
            const checkInBtn = document.getElementById('checkInBtn');
            
            document.getElementById('modalGuestName').innerText = guest.name;
            document.getElementById('modalGuestTable').innerText = `ç¬¬ ${guest.tableId} æ¡Œ`;
            document.getElementById('modalGuestSize').innerText = `${guest.size} äºº`;
            
            invitationCheck.checked = false;

            if (guest.checkedIn) {
                noInvitationAlert.classList.add('hidden');
                hasInvitationBadge.classList.add('hidden');
                checkInBtn.disabled = false;
                checkInBtn.classList.remove('opacity-50', 'cursor-not-allowed');
                updateCheckInBtnUI(true);
            } else {
                if (guest.hasInvitation) {
                    noInvitationAlert.classList.add('hidden');
                    hasInvitationBadge.classList.remove('hidden');
                    checkInBtn.disabled = false;
                    checkInBtn.classList.remove('opacity-50', 'cursor-not-allowed');
                } else {
                    noInvitationAlert.classList.remove('hidden');
                    hasInvitationBadge.classList.add('hidden');
                    checkInBtn.disabled = true;
                    checkInBtn.classList.add('opacity-50', 'cursor-not-allowed');
                }
                updateCheckInBtnUI(false);
            }

            modal.classList.remove('hidden');
            modal.classList.add('flex');
            setTimeout(() => {
                modal.classList.remove('opacity-0');
                content.classList.remove('scale-95');
                content.classList.add('scale-100');
            }, 10);
        }

        function toggleConfirmButton() {
            const checkInBtn = document.getElementById('checkInBtn');
            const checkbox = document.getElementById('invitationCheck');
            
            if (checkbox.checked) {
                checkInBtn.disabled = false;
                checkInBtn.classList.remove('opacity-50', 'cursor-not-allowed');
            } else {
                checkInBtn.disabled = true;
                checkInBtn.classList.add('opacity-50', 'cursor-not-allowed');
            }
        }

        function updateCheckInBtnUI(checkedIn) {
            const btn = document.getElementById('checkInBtn');
            const statusText = document.getElementById('modalStatusText');
            
            if (checkedIn) {
                btn.className = "w-full py-4 rounded-xl font-bold text-lg shadow-lg transform transition-all active:scale-95 flex items-center justify-center gap-2 bg-gray-100 text-gray-500 hover:bg-gray-200 mt-auto";
                btn.innerHTML = '<i class="fas fa-undo"></i> <span>å–æ¶ˆç°½åˆ°</span>';
                statusText.innerText = "å·²ç°½åˆ°";
                statusText.className = "text-xl font-bold text-green-600";
            } else {
                btn.className = "w-full py-4 rounded-xl font-bold text-lg shadow-lg transform transition-all active:scale-95 flex items-center justify-center gap-2 bg-wedding-green text-white shadow-green-200 mt-auto disabled:opacity-50 disabled:cursor-not-allowed";
                btn.innerHTML = '<i class="fas fa-check-circle"></i> <span>ç¢ºèªç°½åˆ°</span>';
                statusText.innerText = "æœªç°½åˆ°";
                statusText.className = "text-xl font-bold text-gray-400";
            }
        }

        function toggleCheckIn() {
            const guest = guests.find(g => g.id === currentGuestId);
            guest.checkedIn = !guest.checkedIn;
            updateCheckInBtnUI(guest.checkedIn);
            renderApp();
            setTimeout(() => { closeModal('checkInModal'); }, 300);
        }

        // --- Car & Image Modal Utils ---
        function openCarModal() {
            document.getElementById('carModal').classList.remove('hidden');
            document.getElementById('carModal').classList.add('flex');
            setTimeout(() => {
                document.getElementById('carModal').classList.remove('opacity-0');
                document.getElementById('carModalContent').classList.remove('scale-95');
                document.getElementById('carModalContent').classList.add('scale-100');
            }, 10);
        }

        function saveCarInfo(e) {
            e.preventDefault();
            const owner = document.getElementById('carOwner').value;
            const plate = document.getElementById('carPlate').value;
            const time = document.getElementById('carTime').value;

            carData.push({ owner, plate, time });
            localStorage.setItem('weddingCars', JSON.stringify(carData));
            renderCarList();
            
            document.getElementById('carForm').reset();
            closeModal('carModal');
        }

        function viewImage(type) {
            const modal = document.getElementById('imageModal');
            const img = document.getElementById('fullImage');
            img.src = "https://images.unsplash.com/photo-1515934751635-c81c6bc9a2d8?q=80&w=2070&auto=format&fit=crop"; 
            modal.classList.remove('hidden');
            modal.classList.add('flex');
        }

        function closeModal(modalId) {
            const modal = document.getElementById(modalId);
            const content = modal.querySelector('div[class*="transform"]');
            
            modal.classList.add('opacity-0');
            if(content) {
                content.classList.remove('scale-100');
                content.classList.add('scale-95');
            }
            
            setTimeout(() => {
                modal.classList.remove('flex');
                modal.classList.add('hidden');
            }, 300);
        }

        // --- Mahjong Logic ---
        function updateMjCount(type, val) {
            if (type === 'flower') {
                mjState.flower = Math.max(0, Math.min(8, mjState.flower + val));
                document.getElementById('mj-flower-count').innerText = mjState.flower;
            } else if (type === 'honor') {
                mjState.honor = Math.max(0, Math.min(8, mjState.honor + val));
                document.getElementById('mj-honor-count').innerText = mjState.honor;
            }
            calcMjTotal();
        }

        function toggleMjFan(btn, fanValue) {
            btn.classList.toggle('active');
            calcMjTotal();
        }

        function calcMjTotal() {
            let total = 0;
            // Add counters
            total += mjState.flower;
            total += mjState.honor;

            // Add active toggles
            const activeBtns = document.querySelectorAll('.mj-toggle.active');
            activeBtns.forEach(btn => {
                const subText = btn.querySelector('.sub-text').innerText;
                const fan = parseInt(subText.replace('+', '').replace('ç•ª', ''));
                total += fan;
            });

            document.getElementById('totalFanDisplay').innerText = total;
            animateValue('totalFanDisplay', parseInt(document.getElementById('totalFanDisplay').innerText), total, 300);
        }

        function resetMahjong() {
            mjState = { flower: 0, honor: 0, fan: 0 };
            document.getElementById('mj-flower-count').innerText = 0;
            document.getElementById('mj-honor-count').innerText = 0;
            document.querySelectorAll('.mj-toggle').forEach(btn => btn.classList.remove('active'));
            calcMjTotal();
        }


        // --- AI Features (Simulated) ---
        async function sendToGemini() {
            const input = document.getElementById('aiInput');
            const userText = input.value;
            if (!userText) return;

            const chatHistory = document.getElementById('chatHistory');
            
            chatHistory.innerHTML += `<div class="chat-bubble user">${userText}</div>`;
            input.value = '';
            chatHistory.scrollTop = chatHistory.scrollHeight;

            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{
                            parts: [{ text: `ä½ æ˜¯ä¸€ä½å°ˆæ¥­çš„å©šç¦®é¡§å•åŠ©æ‰‹ï¼Œè«‹ç”¨ç¹é«”ä¸­æ–‡å›ç­”ä»¥ä¸‹å•é¡Œï¼š${userText}` }]
                        }]
                    })
                });
                
                const data = await response.json();
                const aiResponse = data.candidates?.[0]?.content?.parts?.[0]?.text || "æŠ±æ­‰ï¼Œæˆ‘ç¾åœ¨ç„¡æ³•å›ç­”ã€‚";
                
                chatHistory.innerHTML += `<div class="chat-bubble ai">${aiResponse}</div>`;
                chatHistory.scrollTop = chatHistory.scrollHeight;

            } catch (error) {
                console.error("AI Error:", error);
                chatHistory.innerHTML += `<div class="chat-bubble ai">é€£ç·šç™¼ç”ŸéŒ¯èª¤ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚</div>`;
            }
        }

        function animateValue(id, start, end, duration) {
            if (start === end) return;
            const range = end - start;
            let current = start;
            const increment = end > start ? 1 : -1;
            const stepTime = Math.abs(Math.floor(duration / range));
            const obj = document.getElementById(id);
            if (!obj) return;
            const timer = setInterval(function() {
                current += increment;
                obj.innerHTML = current;
                if (current == end) {
                    clearInterval(timer);
                }
            }, stepTime > 100 ? 100 : stepTime);
        }

        function setupSearch() {
            const input = document.getElementById('searchInput');
            const btn = document.getElementById('clearSearchBtn');
            input.addEventListener('input', (e) => {
                if(e.target.value) btn.classList.remove('hidden');
                else btn.classList.add('hidden');
                renderTables();
            });
        }

        function clearSearch() {
            const input = document.getElementById('searchInput');
            input.value = '';
            document.getElementById('clearSearchBtn').classList.add('hidden');
            renderTables();
        }
    </script>
</body>
</html>
