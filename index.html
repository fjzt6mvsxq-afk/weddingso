<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>婚宴座位與簽到系統</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts: Noto Sans TC & Great Vibes (Cursive) -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&family=Great+Vibes&display=swap" rel="stylesheet">
    <!-- Font Awesome Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['"Noto Sans TC"', 'sans-serif'],
                        cursive: ['"Great Vibes"', 'cursive'],
                    },
                    colors: {
                        wedding: {
                            red: '#8a1c28', // 勃艮第紅
                            darkRed: '#5a121a', // 深紅背景
                            gold: '#c5a059', // 香檳金
                            light: '#fdfbf7', // 米白底色
                            green: '#4a7c59', // 簽到綠
                            pink: '#fce7e9',
                            blue: '#e0f2fe', // 男家藍
                        }
                    },
                    boxShadow: {
                        'up': '0 -10px 25px -5px rgba(0, 0, 0, 0.1), 0 -8px 10px -6px rgba(0, 0, 0, 0.1)',
                        'card': '0 4px 20px rgba(138, 28, 40, 0.08)',
                    }
                }
            }
        }
    </script>

    <style>
        body {
            background-color: #fdfbf7;
            -webkit-tap-highlight-color: transparent;
        }

        /* 花卉線條藝術背景 (Floral Line Art) */
        .floral-bg {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1;
            /* 使用淡雅的花卉線條圖案 */
            background-image: url('https://img.freepik.com/free-vector/hand-drawn-minimal-background_23-2148999829.jpg?w=1380&t=st=1703600000~exp=1703600600~hmac=fake_signature');
            background-size: 400px;
            background-repeat: repeat;
            opacity: 0.08;
            filter: sepia(100%) hue-rotate(320deg) saturate(20%);
            pointer-events: none;
        }

        /* 內容遮罩 & 浮水印 */
        .content-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1;
            background: radial-gradient(circle, rgba(253,251,247,0.4) 0%, rgba(253,251,247,0.9) 100%);
            pointer-events: none;
        }

        /* Shirley & Oscar 浮水印背景 */
        .watermark-bg {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -2; 
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0.03; 
            pointer-events: none;
            font-family: 'Great Vibes', cursive;
            font-size: 15vw; 
            color: #8a1c28;
            transform: rotate(-15deg);
            white-space: nowrap;
        }

        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        .transition-all-300 { transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); }

        /* 簽到狀態樣式 */
        .guest-card.checked-in {
            background: linear-gradient(to bottom right, #f0fdf4, #dcfce7);
            border-color: #86efac;
        }
        .guest-card.checked-in .avatar-box {
            background-color: #16a34a;
            color: white;
        }
        .guest-card.checked-in .check-icon {
            opacity: 1;
            transform: scale(1);
        }

        /* Bottom Navigation Active State */
        .nav-item.active {
            color: #8a1c28;
        }
        .nav-item.active i {
            transform: translateY(-2px);
        }
        
        /* Contact Card Hover */
        .contact-card:active {
            transform: scale(0.98);
            background-color: #fce7e9;
        }

        /* Timeline Styles */
        .timeline-line {
            position: absolute;
            left: 24px;
            top: 20px;
            bottom: 20px;
            width: 2px;
            background: #e5e7eb;
            z-index: 0;
        }
        .timeline-item {
            position: relative;
            padding-left: 60px;
            margin-bottom: 28px;
            z-index: 1;
        }
        .timeline-dot {
            position: absolute;
            left: 16px;
            top: 4px;
            width: 18px;
            height: 18px;
            background: #fff;
            border: 4px solid #8a1c28;
            border-radius: 50%;
            z-index: 2;
        }
        .timeline-time {
            font-weight: bold;
            color: #8a1c28;
            font-size: 0.95rem;
            margin-bottom: 2px;
        }
        .timeline-location {
            font-size: 0.75rem;
            color: #9ca3af;
            display: flex;
            align-items: center;
            gap: 4px;
            margin-top: 2px;
        }
    </style>
</head>
<body class="text-gray-800 antialiased h-screen flex flex-col overflow-hidden">

    <div class="floral-bg"></div>
    <div class="content-overlay"></div>
    <!-- 浮水印背景 -->
    <div class="watermark-bg">Shirley & Oscar</div>

    <!-- Main Scroll Container -->
    <div class="flex-1 overflow-y-auto no-scrollbar relative z-20 pb-24" id="mainScrollContainer">
        
        <!-- Header -->
        <header class="bg-gradient-to-br from-wedding-red to-wedding-darkRed text-white pt-10 pb-8 px-6 rounded-b-[2.5rem] shadow-xl relative z-30 shrink-0 overflow-hidden mb-4">
            <div class="absolute inset-0 opacity-10" style="background-image: url('https://www.transparenttextures.com/patterns/black-linen.png');"></div>
            
            <div class="relative z-10">
                <div class="flex flex-col items-center justify-center mb-8 text-center">
                    <h2 class="text-wedding-gold text-xs font-bold tracking-[0.3em] uppercase mb-2 opacity-90">Wedding Reception</h2>
                    <h1 class="text-5xl font-cursive text-white mb-2 drop-shadow-lg transform -rotate-2">Shirley & Oscar</h1>
                    <div class="w-16 h-0.5 bg-wedding-gold/50 rounded-full mt-2"></div>
                </div>

                <!-- Stats -->
                <div id="header-stats" class="flex justify-between items-end">
                    <div class="flex gap-3 overflow-x-auto pb-2 no-scrollbar w-full mr-4">
                        <div class="bg-white/10 backdrop-blur-md rounded-2xl p-3 min-w-[85px] border border-white/10 shadow-lg text-center">
                            <div class="text-[10px] text-gray-300 mb-1 uppercase tracking-wide">總人數</div>
                            <div class="text-xl font-bold" id="totalHeadcount">0</div>
                        </div>
                        <div class="bg-green-900/40 backdrop-blur-md rounded-2xl p-3 min-w-[85px] border border-green-400/30 shadow-lg text-center">
                            <div class="text-[10px] text-green-200 mb-1 uppercase tracking-wide">已簽到</div>
                            <div class="text-xl font-bold text-green-300" id="checkedInCount">0</div>
                        </div>
                        <div class="bg-white/10 backdrop-blur-md rounded-2xl p-3 min-w-[85px] border border-white/10 shadow-lg text-center">
                            <div class="text-[10px] text-gray-300 mb-1 uppercase tracking-wide">未到</div>
                            <div class="text-xl font-bold text-wedding-gold" id="pendingCount">0</div>
                        </div>
                    </div>

                    <div class="relative w-14 h-14 flex items-center justify-center shrink-0 mb-2">
                        <svg class="transform -rotate-90 w-14 h-14">
                            <circle cx="28" cy="28" r="24" stroke="currentColor" stroke-width="3" fill="transparent" class="text-white/10" />
                            <circle id="progressCircle" cx="28" cy="28" r="24" stroke="#c5a059" stroke-width="3" fill="transparent" stroke-dasharray="150.7" stroke-dashoffset="150.7" class="transition-all duration-1000 ease-out" />
                        </svg>
                        <span class="absolute text-[11px] font-bold" id="progressText">0%</span>
                    </div>
                </div>
            </div>
        </header>
        
        <!-- TAB 1: 賓客名單 (GUESTS) -->
        <main id="tab-guests" class="px-4 pb-6">
            <!-- Search -->
            <div class="bg-white rounded-2xl shadow-card p-4 mb-6 flex items-center gap-3 sticky top-4 z-30 ring-1 ring-gray-100/50">
                <div class="bg-gray-50 rounded-full w-10 h-10 flex items-center justify-center text-wedding-red/50 shrink-0">
                    <i class="fas fa-search"></i>
                </div>
                <input type="text" id="searchInput" placeholder="搜尋賓客姓名..." class="bg-transparent w-full outline-none text-gray-700 placeholder-gray-400 font-medium h-full">
                <button onclick="clearSearch()" id="clearSearchBtn" class="hidden text-gray-400 p-2"><i class="fas fa-times"></i></button>
            </div>
            <div id="tablesContainer" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-5"></div>
        </main>

        <!-- TAB 2: 聯絡資訊 (CONTACTS) -->
        <main id="tab-contacts" class="hidden px-4 pb-6">
            <h2 class="text-xl font-bold text-wedding-red mb-4 pl-2 border-l-4 border-wedding-gold">工作人員通訊錄</h2>
            <div class="grid gap-4" id="contactsContainer"></div>
        </main>

        <!-- TAB 3: 婚禮流程 (TIMELINE) -->
        <main id="tab-timeline" class="hidden px-4 pb-6">
            <h2 class="text-xl font-bold text-wedding-red mb-6 pl-2 border-l-4 border-wedding-gold">婚禮當日流程</h2>
            <p class="text-xs text-gray-400 mb-4 pl-2">日期: JAN 04</p>
            
            <div class="bg-white rounded-3xl p-6 shadow-card relative overflow-hidden">
                <div class="timeline-line"></div>
                <div id="timelineContainer">
                    <!-- JS Populated -->
                </div>
            </div>
        </main>

        <!-- TAB 4: 車牌系統 (PARKING) -->
        <main id="tab-parking" class="hidden px-4 pb-6">
             <div class="flex justify-between items-center mb-6">
                <h2 class="text-xl font-bold text-wedding-red pl-2 border-l-4 border-wedding-gold">工作人員車牌</h2>
                <button onclick="openCarModal()" class="text-sm bg-wedding-red text-white px-4 py-2 rounded-full shadow-lg shadow-wedding-red/30 active:scale-95 transition-transform flex items-center">
                    <i class="fas fa-plus mr-1"></i> 新增
                </button>
            </div>
            
            <div id="carList" class="space-y-3">
                <!-- JS Populated -->
            </div>
        </main>

        <!-- TAB 5: 資訊 (INFO - Weather & AI) -->
        <main id="tab-info" class="hidden px-4 pb-6">
             <!-- 天氣 Widget -->
            <div class="bg-gradient-to-br from-blue-400 to-blue-600 rounded-3xl p-6 text-white shadow-lg mb-8 relative overflow-hidden">
                <div class="absolute top-[-20px] right-[-20px] text-white/20 text-9xl">
                    <i class="fas fa-cloud-sun"></i>
                </div>
                <div class="relative z-10">
                    <h3 class="text-sm font-bold uppercase tracking-wider mb-1 opacity-90">婚禮當日天氣預報</h3>
                    <div class="flex items-end gap-4">
                        <div class="text-5xl font-bold">24°</div>
                        <div class="mb-2 text-lg font-medium">多雲時晴</div>
                    </div>
                    <div class="mt-4 flex gap-4 text-sm opacity-90">
                        <div><i class="fas fa-tint mr-1"></i> 濕度 75%</div>
                        <div><i class="fas fa-wind mr-1"></i> 微風</div>
                    </div>
                </div>
            </div>
            
            <!-- Gemini AI Assistant -->
            <div class="bg-white rounded-3xl shadow-card p-0 mb-8 overflow-hidden border border-purple-100">
                <div class="bg-gradient-to-r from-purple-500 to-indigo-600 p-4 text-white flex justify-between items-center">
                    <div class="flex items-center gap-2">
                        <i class="fas fa-sparkles"></i>
                        <h3 class="font-bold">AI 婚禮顧問</h3>
                    </div>
                </div>
                <div id="chatHistory" class="p-4 h-48 overflow-y-auto bg-gray-50 flex flex-col gap-2">
                    <div class="chat-bubble ai">您好！我是您的婚禮 AI 助手。關於流程、致詞或應急方案，隨時問我！✨</div>
                </div>
                <div class="p-3 border-t border-gray-100 flex gap-2 bg-white">
                    <input type="text" id="aiInput" placeholder="例如: 敬茶有什麼吉利話?" class="flex-1 bg-gray-100 rounded-full px-4 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-purple-200">
                    <button onclick="sendToGemini()" class="w-10 h-10 bg-purple-600 text-white rounded-full flex items-center justify-center hover:bg-purple-700 transition-colors">
                        <i class="fas fa-paper-plane text-xs"></i>
                    </button>
                </div>
            </div>
        </main>
    </div>

    <!-- Bottom Navigation Bar (5 Items) -->
    <nav class="fixed bottom-0 left-0 w-full bg-white/95 backdrop-blur-lg border-t border-gray-200 pb-safe pt-1 px-2 flex justify-around items-center z-40 shadow-[0_-5px_20px_rgba(0,0,0,0.05)] h-[80px]">
        <button onclick="switchTab('guests')" class="nav-item active flex flex-col items-center justify-center w-14 h-full text-gray-400 transition-all duration-300">
            <i class="fas fa-users text-xl mb-1"></i>
            <span class="text-[10px] font-bold">賓客</span>
        </button>
        
        <button onclick="switchTab('contacts')" class="nav-item flex flex-col items-center justify-center w-14 h-full text-gray-400 transition-all duration-300">
            <i class="fas fa-address-book text-xl mb-1"></i>
            <span class="text-[10px] font-bold">聯絡</span>
        </button>

        <button onclick="switchTab('timeline')" class="nav-item flex flex-col items-center justify-center w-14 h-full text-gray-400 transition-all duration-300">
            <i class="fas fa-clock text-xl mb-1"></i>
            <span class="text-[10px] font-bold">流程</span>
        </button>

        <button onclick="switchTab('parking')" class="nav-item flex flex-col items-center justify-center w-14 h-full text-gray-400 transition-all duration-300">
            <i class="fas fa-car text-xl mb-1"></i>
            <span class="text-[10px] font-bold">車牌</span>
        </button>

        <button onclick="switchTab('info')" class="nav-item flex flex-col items-center justify-center w-14 h-full text-gray-400 transition-all duration-300">
            <i class="fas fa-info-circle text-xl mb-1"></i>
            <span class="text-[10px] font-bold">資訊</span>
        </button>
    </nav>

    <!-- MODALS -->

    <!-- 1. Check-in Modal -->
    <div id="checkInModal" class="fixed inset-0 bg-black/70 backdrop-blur-sm hidden items-center justify-center z-50 p-6 opacity-0 transition-opacity duration-300">
        <div class="bg-white w-full max-w-sm rounded-[2rem] shadow-2xl overflow-hidden transform scale-95 transition-transform duration-300 relative flex flex-col" id="checkInContent">
            <button onclick="closeModal('checkInModal')" class="absolute top-4 right-4 z-10 w-8 h-8 bg-gray-100 rounded-full flex items-center justify-center text-gray-500 hover:bg-gray-200">
                <i class="fas fa-times"></i>
            </button>
            <div class="h-32 bg-gradient-to-br from-wedding-red to-wedding-darkRed relative flex items-center justify-center overflow-hidden shrink-0">
                <div class="absolute inset-0 opacity-10" style="background-image: url('https://www.transparenttextures.com/patterns/black-linen.png');"></div>
                <div class="absolute -bottom-8 w-20 h-20 bg-white rounded-full p-1.5 shadow-lg z-10">
                    <div class="w-full h-full bg-gray-100 rounded-full flex items-center justify-center text-3xl font-bold text-wedding-red" id="modalAvatar">
                        <i class="fas fa-user"></i>
                    </div>
                </div>
            </div>
            <div class="pt-12 pb-8 px-6 text-center flex-1 flex flex-col">
                <h2 class="text-2xl font-bold text-gray-800 mb-1" id="modalGuestName">Guest Name</h2>
                <p class="text-sm text-gray-500 mb-4 font-medium" id="modalGuestTable">Table X</p>
                
                <!-- 未領喜帖提示 -->
                <div id="noInvitationAlert" class="hidden mb-4 bg-red-50 border-l-4 border-wedding-red rounded-r-xl p-4 shadow-sm animate-pulse">
                    <div class="flex flex-col items-center justify-center text-wedding-red">
                        <div class="flex items-center gap-2 mb-2">
                            <i class="fas fa-envelope text-xl"></i>
                            <span class="font-bold text-lg">請轉交喜帖一張</span>
                        </div>
                        <div class="flex items-center gap-2 bg-white px-3 py-2 rounded-lg border border-red-100 shadow-sm w-full justify-center">
                            <input type="checkbox" id="invitationCheck" class="w-5 h-5 text-wedding-red rounded focus:ring-wedding-red" onchange="toggleConfirmButton()">
                            <label for="invitationCheck" class="text-sm font-bold text-gray-700 cursor-pointer select-none">我已轉交喜帖</label>
                        </div>
                    </div>
                </div>

                <!-- 已領喜帖標籤 -->
                <div id="hasInvitationBadge" class="hidden mb-6">
                    <div class="inline-flex items-center gap-2 bg-green-100 text-green-700 px-4 py-2 rounded-full font-bold text-sm border border-green-200 shadow-sm">
                        <i class="fas fa-check-circle text-green-600"></i>
                        <span>已領取喜帖</span>
                    </div>
                </div>

                <div class="grid grid-cols-2 gap-3 mb-8">
                    <div class="bg-gray-50 rounded-xl p-3 border border-gray-100">
                        <div class="text-xs text-gray-400 uppercase font-bold tracking-wider">人數</div>
                        <div class="text-xl font-bold text-gray-800" id="modalGuestSize">1</div>
                    </div>
                    <div class="bg-gray-50 rounded-xl p-3 border border-gray-100">
                        <div class="text-xs text-gray-400 uppercase font-bold tracking-wider">狀態</div>
                        <div class="text-xl font-bold" id="modalStatusText">未簽到</div>
                    </div>
                </div>
                <button id="checkInBtn" onclick="toggleCheckIn()" class="w-full py-4 rounded-xl font-bold text-lg shadow-lg transform transition-all active:scale-95 flex items-center justify-center gap-2 mt-auto disabled:opacity-50 disabled:cursor-not-allowed">
                    <!-- Icon & Text injected by JS -->
                </button>
            </div>
        </div>
    </div>

    <!-- 2. Car Info Modal -->
    <div id="carModal" class="fixed inset-0 bg-black/70 backdrop-blur-sm hidden items-center justify-center z-50 p-6 opacity-0 transition-opacity duration-300">
        <div class="bg-white w-full max-w-sm rounded-[2rem] shadow-2xl p-6 transform scale-95 transition-transform duration-300" id="carModalContent">
            <h3 class="text-xl font-bold text-gray-800 mb-4 text-center">新增車牌</h3>
            <form id="carForm" onsubmit="saveCarInfo(event)">
                <div class="space-y-4">
                    <div>
                        <label class="block text-xs font-bold text-gray-400 uppercase mb-1">姓名</label>
                        <input type="text" id="carOwner" required class="w-full bg-gray-50 border-none rounded-xl px-4 py-3 text-gray-800 font-medium focus:ring-2 focus:ring-wedding-gold/50" placeholder="例如: Dicky">
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-gray-400 uppercase mb-1">車牌號碼</label>
                        <input type="text" id="carPlate" required class="w-full bg-gray-50 border-none rounded-xl px-4 py-3 text-gray-800 font-bold focus:ring-2 focus:ring-wedding-gold/50" placeholder="例如: WN3564">
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-gray-400 uppercase mb-1">預計停泊時間 <span class="text-gray-300 normal-case">(非必填)</span></label>
                        <input type="text" id="carTime" class="w-full bg-gray-50 border-none rounded-xl px-4 py-3 text-gray-800 font-medium focus:ring-2 focus:ring-wedding-gold/50" placeholder="例如: 14:00 - 23:00">
                    </div>
                </div>
                <div class="mt-6 flex gap-3">
                    <button type="button" onclick="closeModal('carModal')" class="flex-1 py-3 rounded-xl bg-gray-100 text-gray-500 font-bold">取消</button>
                    <button type="submit" class="flex-1 py-3 rounded-xl bg-wedding-red text-white font-bold shadow-lg shadow-wedding-red/30">儲存</button>
                </div>
            </form>
        </div>
    </div>

    <!-- 3. Image Viewer Modal -->
    <div id="imageModal" class="fixed inset-0 bg-black/90 hidden items-center justify-center z-[60] p-0" onclick="closeModal('imageModal')">
        <img id="fullImage" src="" class="max-w-full max-h-full object-contain" alt="Full Screen Image">
        <button class="absolute top-4 right-4 text-white/70 hover:text-white text-3xl">
            <i class="fas fa-times"></i>
        </button>
    </div>

    <script>
        const apiKey = "";
        const TABLE_COUNT = 19; 
        const SEATS_PER_TABLE = 12;
        
        const TABLE_INFO = {
            1: { title: "主家席", color: "gold" },
            2: { title: "男家長輩", color: "red" },
            3: { title: "女家長輩", color: "red" },
            5: { title: "女家親戚", color: "pink" },
            6: { title: "男家朋友", color: "blue" },
            7: { title: "男家朋友", color: "blue" },
            8: { title: "女家親戚", color: "pink" },
            9: { title: "女家朋友", color: "pink" },
            10: { title: "男家朋友", color: "blue" },
            11: { title: "男家朋友", color: "blue" },
            12: { title: "女家朋友", color: "pink" },
            13: { title: "女家朋友", color: "pink" },
            15: { title: "男家朋友", color: "blue" },
            16: { title: "男家朋友", color: "blue" },
            17: { title: "女家朋友", color: "pink" },
            18: { title: "男家朋友", color: "blue" },
            19: { title: "男家朋友", color: "blue" }
        };

        // Guest List - STRICTLY following your updated request from PDF (7)
        // hasInvitation: true (Blue text), false (Black text)
        // Checked against your text list of "已收到"
        let rawGuests = [
            // Table 1 (主家席)
            { name: "新郎媽媽", tableId: 1, hasInvitation: true },
            { name: "新郎姨丈(+新郎姨媽,新郎表哥,新郎表姐)", tableId: 1, manualSize: 4, hasInvitation: false },
            { name: "吳生(Mr Roger Ng)+吳太(Ms Amy Leung)", tableId: 1, manualSize: 2, hasInvitation: true },
            { name: "新郎表姨(Shirley Hui) (+表姨丈)", tableId: 1, manualSize: 2, hasInvitation: false },
            { name: "新郎大舅父 (Steven Hui) (+舅母)", tableId: 1, manualSize: 2, hasInvitation: false },
            { name: "新郎舅父(Stanley Hui) (+舅母)", tableId: 1, manualSize: 2, hasInvitation: false },
            { name: "胡生(+許小姐+胡超文)", tableId: 1, manualSize: 3, hasInvitation: false },
            { name: "永高老叔(+老嬸)", tableId: 1, manualSize: 2, hasInvitation: true },
            { name: "新郎", tableId: 1, hasInvitation: true },
            { name: "新娘", tableId: 1, hasInvitation: true },
            
            // Table 2 (男家長輩 - Updated names)
            { name: "文昭舅舅(+舅母)", tableId: 2, manualSize: 2, hasInvitation: false },
            { name: "炯强舅舅(+舅母)", tableId: 2, manualSize: 2, hasInvitation: false },
            { name: "耀滨舅舅(+舅母)", tableId: 2, manualSize: 2, hasInvitation: false }, // Updated
            { name: "基茂舅舅(+舅母)", tableId: 2, manualSize: 2, hasInvitation: false }, // Updated (+舅母) from PDF 7
            { name: "盛少英(+林先生)", tableId: 2, manualSize: 2, hasInvitation: false },
            { name: "劉建文叔叔(+劉太)", tableId: 2, manualSize: 2, hasInvitation: false }, // Updated name

            // Table 3 (女家長輩 - All true)
            { name: "新娘爸爸", tableId: 3, hasInvitation: true }, 
            { name: "新娘媽媽", tableId: 3, hasInvitation: true }, 
            { name: "新娘嫲嫲", tableId: 3, hasInvitation: true },
            { name: "新娘外公", tableId: 3, hasInvitation: true }, 
            { name: "倩兒姨婆", tableId: 3, hasInvitation: true }, { name: "錫生舅公", tableId: 3, hasInvitation: true },
            { name: "麗兒姨婆", tableId: 3, hasInvitation: true }, { name: "燕兒姨婆", tableId: 3, hasInvitation: true }, 
            { name: "天虹姑婆", tableId: 3, hasInvitation: true }, { name: "曉虹姑婆", tableId: 3, hasInvitation: true }, 
            { name: "區清姨婆", tableId: 3, hasInvitation: true }, { name: "梅冰姨公", tableId: 3, hasInvitation: true },

            // Table 5 (女家親戚)
            { name: "徐偉舅舅", tableId: 5, hasInvitation: false }, { name: "Reiki", tableId: 5, hasInvitation: false }, 
            { name: "毓麗姑婆全家(+5位)", tableId: 5, manualSize: 6, hasInvitation: false }, // Updated name
            { name: "王向紅", tableId: 5, hasInvitation: false }, 
            { name: "吳承菊", tableId: 5, hasInvitation: false }, 
            { name: "吳起恕", tableId: 5, hasInvitation: false },

            // Table 6 (男家朋友)
            { name: "綺華", tableId: 6, hasInvitation: false }, { name: "錦鑾", tableId: 6, hasInvitation: false }, 
            { name: "佩華", tableId: 6, hasInvitation: false }, { name: "淑華", tableId: 6, hasInvitation: false }, 
            { name: "宋吟", tableId: 6, hasInvitation: false }, { name: "燕芬", tableId: 6, hasInvitation: false },
            { name: "玉娥", tableId: 6, hasInvitation: false }, { name: "姚晴萱", tableId: 6, hasInvitation: false }, 
            { name: "姚澤彬", tableId: 6, hasInvitation: false }, { name: "劉子鈞(+3位)", tableId: 6, manualSize: 4, hasInvitation: false },

            // Table 7 (男家朋友)
            // Updated list from PDF 7 + user text
            { name: "吳总", tableId: 7, hasInvitation: false }, { name: "Carly Ng", tableId: 7, hasInvitation: false }, 
            { name: "徐生", tableId: 7, hasInvitation: false }, { name: "Stephanus (+4)", tableId: 7, manualSize: 5, hasInvitation: false },
            { name: "徐總", tableId: 7, hasInvitation: true }, 
            { name: "Jimmy", tableId: 7, hasInvitation: true },
            { name: "Miyuki Sze", tableId: 7, hasInvitation: false }, // New from PDF 7
            { name: "Lala Wong", tableId: 7, hasInvitation: false }, // New from PDF 7

            // Table 8 (女家親戚)
            { name: "梅士平叔叔", tableId: 8, hasInvitation: false }, { name: "燕華嬸嬸", tableId: 8, hasInvitation: false }, 
            { name: "玟鏵姑姐", tableId: 8, hasInvitation: false }, { name: "海歐叔叔", tableId: 8, hasInvitation: false }, 
            { name: "黃沛瑜", tableId: 8, hasInvitation: false }, 
            { name: "黃海洋(+1位)", tableId: 8, manualSize: 2, hasInvitation: false }, 
            { name: "斌毅舅舅全家(+2位)", tableId: 8, manualSize: 3, hasInvitation: false }, 
            { name: "Alex Wong", tableId: 8, hasInvitation: false }, { name: "Jack Wong", tableId: 8, hasInvitation: false },

            // Table 9 (女家朋友)
            { name: "Leila", tableId: 9, hasInvitation: false }, { name: "Ana", tableId: 9, hasInvitation: false }, 
            { name: "Gavin", tableId: 9, hasInvitation: false }, { name: "Davina", tableId: 9, hasInvitation: false }, 
            { name: "Catherine", tableId: 9, hasInvitation: false }, { name: "Lemon", tableId: 9, hasInvitation: false },
            { name: "Nora", tableId: 9, hasInvitation: false }, { name: "Brian", tableId: 9, hasInvitation: false }, 
            { name: "Kiki", tableId: 9, hasInvitation: false }, { name: "Jorie", tableId: 9, hasInvitation: false }, 
            { name: "Yichen", tableId: 9, hasInvitation: false }, { name: "Katia", tableId: 9, hasInvitation: false },

            // Table 10 (男家朋友 - Only 陳凱偉 true)
            { name: "大眼仔2", tableId: 10, manualSize: 2, hasInvitation: false }, 
            { name: "Ng Ming Kin(+3位)", tableId: 10, manualSize: 4, hasInvitation: false }, 
            { name: "Sunkist Sit", tableId: 10, hasInvitation: false },
            { name: "陳凱偉", tableId: 10, hasInvitation: true }, 
            { name: "黃國翹(+1位)", tableId: 10, manualSize: 2, hasInvitation: false }, 
            { name: "方齊發(+1位)", tableId: 10, manualSize: 2, hasInvitation: false },

            // Table 11 (男家朋友 - Sammi, Crystal, Michelle, Joe Lo true)
            { name: "Sammi", tableId: 11, hasInvitation: true }, { name: "Crystal", tableId: 11, hasInvitation: true }, 
            { name: "Michelle", tableId: 11, hasInvitation: true }, { name: "Joe Lo", tableId: 11, hasInvitation: true }, 
            { name: "Winky Chau", tableId: 11, hasInvitation: false }, 
            { name: "鄭國鏘(+3位)", tableId: 11, manualSize: 4, hasInvitation: false },
            { name: "Kathy Keh", tableId: 11, hasInvitation: false }, { name: "Kayleen Keh", tableId: 11, hasInvitation: false }, 
            { name: "Miyuki sze", tableId: 11, hasInvitation: false },

            // Table 12 (女家朋友)
            { name: "Phoebe", tableId: 12, hasInvitation: false }, { name: "Tingting", tableId: 12, hasInvitation: false }, 
            { name: "Darren", tableId: 12, hasInvitation: false }, { name: "Chris", tableId: 12, hasInvitation: false }, 
            { name: "Siann", tableId: 12, hasInvitation: false }, { name: "Miror", tableId: 12, hasInvitation: false },
            { name: "KC", tableId: 12, hasInvitation: false }, { name: "Brian", tableId: 12, hasInvitation: false }, 
            { name: "Wilson", tableId: 12, hasInvitation: false }, { name: "Andy", tableId: 12, hasInvitation: false }, 
            { name: "Anthony", tableId: 12, hasInvitation: false }, { name: "justin", tableId: 12, hasInvitation: false },

            // Table 13 (女家朋友)
            { name: "Kelly(+3位)", tableId: 13, manualSize: 4, hasInvitation: false }, 
            { name: "Lancy", tableId: 13, hasInvitation: false }, { name: "Betty", tableId: 13, hasInvitation: false }, 
            { name: "Lauren (+1位)", tableId: 13, manualSize: 2, hasInvitation: false }, 
            { name: "Linda Pak (+2位)", tableId: 13, manualSize: 3, hasInvitation: false },

            // Table 15 (男家朋友 - Specified True)
            { name: "Jason Wong", tableId: 15, hasInvitation: true }, { name: "Wiliam Wong", tableId: 15, hasInvitation: true }, 
            { name: "James Lo", tableId: 15, hasInvitation: true }, { name: "Nik Po", tableId: 15, hasInvitation: true }, 
            { name: "林霞", tableId: 15, hasInvitation: true }, { name: "凌生", tableId: 15, hasInvitation: true },
            { name: "張天永", tableId: 15, hasInvitation: false }, 
            { name: "林生(2位)", tableId: 15, manualSize: 2, hasInvitation: true }, 
            { name: "劉总", tableId: 15, hasInvitation: true },
            { name: "Sanda Tsang", tableId: 15, hasInvitation: true }, { name: "Lala", tableId: 15, hasInvitation: true },

            // Table 16 (男家朋友 - Rannie Yu True)
            { name: "暢(兒子)", tableId: 16, hasInvitation: false }, { name: "葉堡琛", tableId: 16, hasInvitation: false }, 
            { name: "劉子軒(3位)", tableId: 16, manualSize: 3, hasInvitation: false },
            { name: "林綺婷", tableId: 16, hasInvitation: false }, { name: "朱岸南", tableId: 16, hasInvitation: false }, 
            { name: "Dicky Cheung", tableId: 16, hasInvitation: false }, { name: "Karen Law", tableId: 16, hasInvitation: false }, 
            { name: "范嘉俊", tableId: 16, hasInvitation: false }, { name: "任旭陽", tableId: 16, hasInvitation: false },
            { name: "Rannie Yu", tableId: 16, hasInvitation: true }, 

            // Table 17 (女家朋友)
            { name: "Denise", tableId: 17, hasInvitation: false }, { name: "Leo", tableId: 17, hasInvitation: false }, 
            { name: "Gloria", tableId: 17, hasInvitation: false }, { name: "Mackie", tableId: 17, hasInvitation: false }, 
            { name: "Brina", tableId: 17, hasInvitation: false }, { name: "Ashley", tableId: 17, hasInvitation: false },
            { name: "Shiiko", tableId: 17, hasInvitation: false }, { name: "Jaye", tableId: 17, hasInvitation: false }, 
            { name: "Cheryl", tableId: 17, hasInvitation: false }, { name: "Betsy", tableId: 17, hasInvitation: false }, 
            { name: "Joe", tableId: 17, hasInvitation: false }, { name: "Pakki", tableId: 17, hasInvitation: false },

            // Table 18 (男家朋友)
            { name: "Crystal", tableId: 18, hasInvitation: false }, { name: "Ada", tableId: 18, hasInvitation: false }, 
            { name: "Angel", tableId: 18, hasInvitation: false }, { name: "Celia", tableId: 18, hasInvitation: false }, 
            { name: "Siu Yuk", tableId: 18, hasInvitation: false }, { name: "Momoco", tableId: 18, hasInvitation: false },
            { name: "Alison", tableId: 18, hasInvitation: false }, { name: "陳嘉安", tableId: 18, hasInvitation: false }, 
            { name: "John", tableId: 18, hasInvitation: false }, { name: "Or fu", tableId: 18, hasInvitation: false },

            // Table 19 (男家朋友 - All true)
            { name: "Kelvin Li", tableId: 19, hasInvitation: true }, { name: "Matt", tableId: 19, hasInvitation: true }, 
            { name: "Hayley", tableId: 19, hasInvitation: true }, { name: "Ivy", tableId: 19, hasInvitation: true }, 
            { name: "Ting fung", tableId: 19, hasInvitation: true }, { name: "Roxanne", tableId: 19, hasInvitation: true },
            { name: "Gigi", tableId: 19, hasInvitation: true }, { name: "Bonnie", tableId: 19, hasInvitation: true }, 
            { name: "Vicky", tableId: 19, hasInvitation: true }, { name: "Moon", tableId: 19, hasInvitation: true }, 
            { name: "Sandra", tableId: 19, hasInvitation: true }, { name: "Cling", tableId: 19, hasInvitation: true },
        ];

        // Contact Data
        const contacts = [
            { role: "酒店負責人", name: "Sharon", phone: "+85297434761" },
            { role: "新娘", name: "Shirley", phone: "+85265063298" },
            { role: "新郎", name: "Oscar", phone: "+85265752256" },
            { role: "化妝師", name: "MUA", phone: "+85261603653" },
            { role: "髮型師", name: "Stylist", phone: "+85269737622" },
            { role: "攝影師", name: "Photog 1", phone: "+8529563564" },
            { role: "攝影師", name: "Photog 2", phone: "+85292642380" },
            { role: "姊妹", name: "Sandra", phone: "+85266217286" },
            { role: "姊妹", name: "Roxanne", phone: "+85291982178" },
            { role: "姊妹", name: "TF", phone: "+85260278536" }
        ];

        // Default Car Data
        const defaultCars = [
            { owner: "Dicky", plate: "WN3564", time: "全日" },
            { owner: "Ng’s", plate: "NG7879", time: "全日" },
            { owner: "Scott", plate: "YM4955", time: "全日" }
        ];

        // Updated Wedding Timeline Data from CSV
        const timelineData = [
            { time: "05:00:00", event: "Make up get ready", location: "" },
            { time: "06:00:00", event: "髮型師上房", location: "" },
            { time: "06:30:00", event: "Everyone stand by", location: "" },
            { time: "07:00:00", event: "Photo time", location: "Bride + Bridemates+ Bride Mum" },
            { time: "08:00:00", event: "Groom to pick up the Bride", location: "" },
            { time: "08:20", event: "愛的宣言 + Photo time", location: "Hotel room (Upstairs)" },
            { time: "08:30 - 09:00", event: "Tea time (Bride's relatives)", location: "Hotel room (Upstairs)" },
            { time: "09:10:00", event: "Tea time (Groom's relatives)", location: "G/F Tea room (Near to the ballroom)" },
            { time: "09:50-10:00", event: "Lawyer 10 mins", location: "Tea room" },
            { time: "10:00-10:30", event: "Change clothes", location: "down stairs changing room" },
            { time: "10:30-11:00", event: "Photo time at restaurant", location: "QURA" },
            { time: "11:00-12:00", event: "Reception time", location: "" },
            { time: "12:00-12:30", event: "Change clothes", location: "Changing room" },
            { time: "12:30:00", event: "Video 1 (婚禮開場片) / MC opening", location: "Ballroom" },
            { time: "12:30:00", event: "Groom & Bride enter / Cut Cake", location: "Ballroom" },
        ];

        let guests = [];
        let carData = [];
        let currentGuestId = null;

        document.addEventListener('DOMContentLoaded', () => {
            initGuests();
            initContacts();
            initCars();
            initTimeline();
            renderApp();
            setupSearch();
        });

        // --- Init Functions ---
        function initGuests() {
            guests = rawGuests.map((g, index) => {
                let size = 1;
                if (g.manualSize) {
                    size = g.manualSize;
                } else {
                    const name = g.name;
                    const plusMatch = name.match(/\(\+(\d+)(?:位|人)?\)/);
                    if (plusMatch) size = 1 + parseInt(plusMatch[1]);
                    const bracketMatch = name.match(/\((\d+)[位人]\)/);
                    if (bracketMatch) size = parseInt(bracketMatch[1]);
                    const spaceNumMatch = name.match(/\s(\d+)$/);
                    if (spaceNumMatch) size = parseInt(spaceNumMatch[1]);
                    if (name.includes("伉儷") && !plusMatch && !bracketMatch) size = 2;
                }
                return {
                    id: index + 1,
                    name: g.name,
                    tableId: g.tableId,
                    size: size,
                    checkedIn: false,
                    hasInvitation: g.hasInvitation === true 
                };
            });
        }

        function initContacts() {
            const container = document.getElementById('contactsContainer');
            container.innerHTML = contacts.map(c => `
                <div class="contact-card bg-white p-4 rounded-2xl shadow-sm border border-gray-100 flex items-center justify-between transition-transform">
                    <div class="flex items-center gap-4">
                        <div class="w-10 h-10 rounded-full bg-wedding-pink text-wedding-red flex items-center justify-center font-bold text-sm">
                            ${c.role.substring(0, 1)}
                        </div>
                        <div>
                            <div class="font-bold text-gray-800">${c.name}</div>
                            <div class="text-xs text-gray-500">${c.role}</div>
                        </div>
                    </div>
                    <a href="https://wa.me/${c.phone.replace(/[^0-9]/g, '')}" target="_blank" class="bg-[#25D366] text-white w-10 h-10 rounded-full flex items-center justify-center shadow-md active:scale-95 transition-transform">
                        <i class="fab fa-whatsapp text-xl"></i>
                    </a>
                </div>
            `).join('');
        }

        function initTimeline() {
            const container = document.getElementById('timelineContainer');
            container.innerHTML = timelineData.map(item => `
                <div class="timeline-item">
                    <div class="timeline-dot"></div>
                    <div class="timeline-time">${item.time}</div>
                    <div class="text-gray-800 font-bold">${item.event}</div>
                    ${item.location ? `<div class="timeline-location"><i class="fas fa-map-marker-alt"></i> ${item.location}</div>` : ''}
                </div>
            `).join('');
        }

        function initCars() {
            const storedCars = localStorage.getItem('weddingCars');
            if (storedCars) {
                carData = JSON.parse(storedCars);
            } else {
                carData = defaultCars;
                localStorage.setItem('weddingCars', JSON.stringify(carData));
            }
            renderCarList();
        }

        // --- Render Functions ---
        function renderApp() {
            renderStats();
            renderTables();
        }

        function renderStats() {
            const totalHeadcount = guests.reduce((sum, g) => sum + g.size, 0);
            const checkedInHeadcount = guests.filter(g => g.checkedIn).reduce((sum, g) => sum + g.size, 0);
            const pendingHeadcount = totalHeadcount - checkedInHeadcount;

            animateValue("totalHeadcount", parseInt(document.getElementById("totalHeadcount").innerText), totalHeadcount, 500);
            animateValue("checkedInCount", parseInt(document.getElementById("checkedInCount").innerText), checkedInHeadcount, 500);
            document.getElementById('pendingCount').innerText = pendingHeadcount;
            
            if(document.getElementById("totalHeadcount")) document.getElementById("totalHeadcount").innerText = totalHeadcount;
        }

        function renderTables() {
            const container = document.getElementById('tablesContainer');
            container.innerHTML = '';
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();

            for (let i = 1; i <= TABLE_COUNT; i++) {
                if (i === 4 || i === 14) continue;

                let tableGuests = guests.filter(g => g.tableId === i);
                if (searchTerm) {
                    const hasMatch = tableGuests.some(g => g.name.toLowerCase().includes(searchTerm));
                    if (!hasMatch) continue;
                }

                const currentHeadcount = tableGuests.reduce((sum, g) => sum + g.size, 0);
                const isOverCapacity = currentHeadcount > SEATS_PER_TABLE;
                const info = TABLE_INFO[i] || { title: `第 ${i} 桌`, color: 'gray' };
                
                let headerBg, borderColor, titleColor, subTitle, iconBg, iconColor;

                // Color Logic
                if (info.color === "gold") {
                    headerBg = 'bg-gradient-to-r from-wedding-gold/20 to-white';
                    titleColor = 'text-[#856404]';
                    borderColor = 'border-wedding-gold/40';
                    iconBg = 'bg-wedding-gold/20';
                    iconColor = 'text-[#856404]';
                    subTitle = `<span class="text-xs text-wedding-gold font-bold ml-2">(${info.title})</span>`;
                } else if (info.color === "red") {
                    headerBg = 'bg-gradient-to-r from-wedding-red/10 to-white';
                    titleColor = 'text-wedding-red';
                    borderColor = 'border-wedding-red/20';
                    iconBg = 'bg-wedding-red/10';
                    iconColor = 'text-wedding-red';
                    subTitle = `<span class="text-xs text-wedding-red font-bold ml-2">(${info.title})</span>`;
                } else if (info.color === "blue") {
                    headerBg = 'bg-gradient-to-r from-blue-100 to-white';
                    titleColor = 'text-blue-800';
                    borderColor = 'border-blue-200';
                    iconBg = 'bg-blue-100';
                    iconColor = 'text-blue-600';
                    subTitle = `<span class="text-xs text-blue-600 font-bold ml-2">(${info.title})</span>`;
                } else if (info.color === "pink") {
                    headerBg = 'bg-gradient-to-r from-pink-100 to-white';
                    titleColor = 'text-pink-800';
                    borderColor = 'border-pink-200';
                    iconBg = 'bg-pink-100';
                    iconColor = 'text-pink-600';
                    subTitle = `<span class="text-xs text-pink-600 font-bold ml-2">(${info.title})</span>`;
                } else {
                    headerBg = 'bg-white';
                    titleColor = 'text-gray-800';
                    borderColor = 'border-transparent';
                    iconBg = 'bg-gray-100';
                    iconColor = 'text-gray-400';
                    subTitle = `<span class="text-xs text-gray-400 font-normal ml-2">${info.title}</span>`;
                }

                let cardHTML = `
                    <div class="bg-white/90 backdrop-blur-sm rounded-3xl shadow-card overflow-hidden border-2 ${borderColor} transition-all duration-300 hover:shadow-xl group-hover:border-wedding-gold/30">
                        <div class="p-4 border-b border-gray-100 flex justify-between items-center ${headerBg}">
                            <div class="flex items-center">
                                <div class="w-8 h-8 rounded-full ${iconBg} ${iconColor} flex items-center justify-center font-bold text-sm mr-2">
                                    ${i}
                                </div>
                                <h3 class="font-bold text-lg ${titleColor}">第 ${i} 桌${subTitle}</h3>
                            </div>
                            <span class="text-xs font-bold ${isOverCapacity ? 'text-red-500' : 'text-gray-400'} bg-gray-50 px-2 py-1 rounded-lg">
                                <i class="fas fa-users mr-1"></i> ${currentHeadcount}/${SEATS_PER_TABLE}
                            </span>
                        </div>
                        
                        <div class="p-3 min-h-[80px]">
                            <div class="flex flex-wrap gap-2">
                                ${tableGuests.map(guest => {
                                    const opacityClass = searchTerm && !guest.name.toLowerCase().includes(searchTerm) ? 'opacity-30' : 'opacity-100';
                                    
                                    return `
                                    <div onclick="openCheckInModal(${guest.id})" class="guest-card ${guest.checkedIn ? 'checked-in' : 'bg-gray-50'} ${opacityClass} cursor-pointer group relative border border-gray-100 rounded-xl px-3 py-2 flex items-center transition-all duration-200 hover:scale-105 active:scale-95 w-full sm:w-auto hover:border-wedding-gold/30 hover:shadow-md">
                                        <div class="avatar-box w-8 h-8 rounded-full ${guest.checkedIn ? 'bg-wedding-green text-white' : 'bg-white text-gray-300'} flex items-center justify-center text-xs font-bold mr-3 shadow-sm transition-colors">
                                            ${guest.checkedIn ? '<i class="fas fa-check"></i>' : (guest.size > 1 ? guest.size : '<i class="fas fa-user"></i>')}
                                        </div>
                                        
                                        <div class="flex-1">
                                            <div class="text-sm font-bold text-gray-700 leading-tight flex items-center justify-between">
                                                <span class="${guest.hasInvitation ? 'text-blue-600' : 'text-black'}">${guest.name}</span>
                                            </div>
                                            ${guest.size > 1 ? `<div class="text-[10px] text-gray-400 font-medium">共 ${guest.size} 位</div>` : ''}
                                        </div>

                                        ${guest.checkedIn ? '<div class="absolute right-2 top-1/2 transform -translate-y-1/2 text-wedding-green/20 text-4xl -z-0 pointer-events-none"><i class="fas fa-check-circle"></i></div>' : ''}
                                    </div>
                                `}).join('')}
                            </div>
                        </div>
                    </div>
                `;
                container.innerHTML += cardHTML;
            }
        }

        function renderCarList() {
            const list = document.getElementById('carList');
            list.innerHTML = carData.map((car, index) => `
                <div class="bg-white p-4 rounded-xl border border-gray-100 shadow-sm flex justify-between items-center group">
                    <div>
                        <div class="font-bold text-gray-800">${car.owner} <span class="text-wedding-red ml-2 bg-wedding-pink px-2 rounded text-xs">${car.plate}</span></div>
                        <div class="text-xs text-gray-500 mt-1"><i class="far fa-clock mr-1"></i> ${car.time || '全日'}</div>
                    </div>
                    <!-- Delete button removed as requested -->
                </div>
            `).join('');
        }

        // --- Interaction Logic ---
        function switchTab(tabName) {
            ['guests', 'contacts', 'timeline', 'parking', 'info'].forEach(t => {
                document.getElementById(`tab-${t}`).classList.add('hidden');
            });
            document.getElementById(`tab-${tabName}`).classList.remove('hidden');
            
            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active', 'text-wedding-red'));
            const activeBtn = document.querySelector(`.nav-item[onclick="switchTab('${tabName}')"]`);
            activeBtn.classList.add('active', 'text-wedding-red');
            document.getElementById('mainScrollContainer').scrollTop = 0;
            
            // Show/Hide header stats
            if(tabName === 'guests') {
                document.getElementById('header-stats').classList.remove('hidden');
            } else {
                document.getElementById('header-stats').classList.add('hidden');
            }
        }

        function openCheckInModal(id) {
            currentGuestId = id;
            const guest = guests.find(g => g.id === id);
            const modal = document.getElementById('checkInModal');
            const content = document.getElementById('checkInContent');
            const noInvitationAlert = document.getElementById('noInvitationAlert');
            const hasInvitationBadge = document.getElementById('hasInvitationBadge');
            const invitationCheck = document.getElementById('invitationCheck');
            const checkInBtn = document.getElementById('checkInBtn');
            
            document.getElementById('modalGuestName').innerText = guest.name;
            document.getElementById('modalGuestTable').innerText = `第 ${guest.tableId} 桌`;
            document.getElementById('modalGuestSize').innerText = `${guest.size} 人`;
            
            invitationCheck.checked = false;

            if (guest.checkedIn) {
                // 已簽到：隱藏提示，顯示取消按鈕
                noInvitationAlert.classList.add('hidden');
                hasInvitationBadge.classList.add('hidden');
                checkInBtn.disabled = false;
                checkInBtn.classList.remove('opacity-50', 'cursor-not-allowed');
                updateCheckInBtnUI(true);
            } else {
                if (guest.hasInvitation) {
                    // 已領喜帖 (藍色字)：顯示綠色標籤，不需勾選，按鈕可用
                    noInvitationAlert.classList.add('hidden');
                    hasInvitationBadge.classList.remove('hidden');
                    checkInBtn.disabled = false;
                    checkInBtn.classList.remove('opacity-50', 'cursor-not-allowed');
                } else {
                    // 未領喜帖 (黑色字)：顯示紅色提示+Checkbox，按鈕禁用
                    noInvitationAlert.classList.remove('hidden');
                    hasInvitationBadge.classList.add('hidden');
                    checkInBtn.disabled = true;
                    checkInBtn.classList.add('opacity-50', 'cursor-not-allowed');
                }
                updateCheckInBtnUI(false);
            }

            modal.classList.remove('hidden');
            modal.classList.add('flex');
            setTimeout(() => {
                modal.classList.remove('opacity-0');
                content.classList.remove('scale-95');
                content.classList.add('scale-100');
            }, 10);
        }

        function toggleConfirmButton() {
            const checkInBtn = document.getElementById('checkInBtn');
            const checkbox = document.getElementById('invitationCheck');
            
            if (checkbox.checked) {
                checkInBtn.disabled = false;
                checkInBtn.classList.remove('opacity-50', 'cursor-not-allowed');
            } else {
                checkInBtn.disabled = true;
                checkInBtn.classList.add('opacity-50', 'cursor-not-allowed');
            }
        }

        function updateCheckInBtnUI(checkedIn) {
            const btn = document.getElementById('checkInBtn');
            const statusText = document.getElementById('modalStatusText');
            
            if (checkedIn) {
                btn.className = "w-full py-4 rounded-xl font-bold text-lg shadow-lg transform transition-all active:scale-95 flex items-center justify-center gap-2 bg-gray-100 text-gray-500 hover:bg-gray-200 mt-auto";
                btn.innerHTML = '<i class="fas fa-undo"></i> <span>取消簽到</span>';
                statusText.innerText = "已簽到";
                statusText.className = "text-xl font-bold text-green-600";
            } else {
                btn.className = "w-full py-4 rounded-xl font-bold text-lg shadow-lg transform transition-all active:scale-95 flex items-center justify-center gap-2 bg-wedding-green text-white shadow-green-200 mt-auto disabled:opacity-50 disabled:cursor-not-allowed";
                btn.innerHTML = '<i class="fas fa-check-circle"></i> <span>確認簽到</span>';
                statusText.innerText = "未簽到";
                statusText.className = "text-xl font-bold text-gray-400";
            }
        }

        function toggleCheckIn() {
            const guest = guests.find(g => g.id === currentGuestId);
            guest.checkedIn = !guest.checkedIn;
            updateCheckInBtnUI(guest.checkedIn);
            renderApp();
            setTimeout(() => { closeModal('checkInModal'); }, 300);
        }

        // --- Car & Image Modal Utils ---
        function openCarModal() {
            document.getElementById('carModal').classList.remove('hidden');
            document.getElementById('carModal').classList.add('flex');
            setTimeout(() => {
                document.getElementById('carModal').classList.remove('opacity-0');
                document.getElementById('carModalContent').classList.remove('scale-95');
                document.getElementById('carModalContent').classList.add('scale-100');
            }, 10);
        }

        function saveCarInfo(e) {
            e.preventDefault();
            const owner = document.getElementById('carOwner').value;
            const plate = document.getElementById('carPlate').value;
            const time = document.getElementById('carTime').value;

            carData.push({ owner, plate, time });
            localStorage.setItem('weddingCars', JSON.stringify(carData));
            renderCarList();
            
            document.getElementById('carForm').reset();
            closeModal('carModal');
        }

        // 刪除功能已移除

        function closeModal(modalId) {
            const modal = document.getElementById(modalId);
            const content = modal.querySelector('div[class*="transform"]');
            
            modal.classList.add('opacity-0');
            if(content) {
                content.classList.remove('scale-100');
                content.classList.add('scale-95');
            }
            
            setTimeout(() => {
                modal.classList.remove('flex');
                modal.classList.add('hidden');
            }, 300);
        }

        // --- AI Features (Simulated) ---
        async function aiSearchAssist() {
            const input = document.getElementById('searchInput');
            const query = input.value;
            if (!query) return alert("請先輸入一些關鍵字，例如「新郎同學」");
            alert(`[AI 助手] 正在為您搜尋符合 "${query}" 特徵的賓客...\n(此為演示功能)`);
        }

        async function sendToGemini() {
            const input = document.getElementById('aiInput');
            const userText = input.value;
            if (!userText) return;

            const chatHistory = document.getElementById('chatHistory');
            
            chatHistory.innerHTML += `<div class="chat-bubble user">${userText}</div>`;
            input.value = '';
            chatHistory.scrollTop = chatHistory.scrollHeight;

            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{
                            parts: [{ text: `你是一位專業的婚禮顧問助手，請用繁體中文回答以下問題：${userText}` }]
                        }]
                    })
                });
                
                const data = await response.json();
                const aiResponse = data.candidates?.[0]?.content?.parts?.[0]?.text || "抱歉，我現在無法回答。";
                
                chatHistory.innerHTML += `<div class="chat-bubble ai">${aiResponse}</div>`;
                chatHistory.scrollTop = chatHistory.scrollHeight;

            } catch (error) {
                console.error("AI Error:", error);
                chatHistory.innerHTML += `<div class="chat-bubble ai">連線發生錯誤，請稍後再試。</div>`;
            }
        }

        function animateValue(id, start, end, duration) {
            if (start === end) return;
            const range = end - start;
            let current = start;
            const increment = end > start ? 1 : -1;
            const stepTime = Math.abs(Math.floor(duration / range));
            const obj = document.getElementById(id);
            if (!obj) return;
            const timer = setInterval(function() {
                current += increment;
                obj.innerHTML = current;
                if (current == end) {
                    clearInterval(timer);
                }
            }, stepTime > 100 ? 100 : stepTime);
        }

        function setupSearch() {
            const input = document.getElementById('searchInput');
            const btn = document.getElementById('clearSearchBtn');
            input.addEventListener('input', (e) => {
                if(e.target.value) btn.classList.remove('hidden');
                else btn.classList.add('hidden');
                renderTables();
            });
        }

        function clearSearch() {
            const input = document.getElementById('searchInput');
            input.value = '';
            document.getElementById('clearSearchBtn').classList.add('hidden');
            renderTables();
        }
    </script>
</body>
</html>
