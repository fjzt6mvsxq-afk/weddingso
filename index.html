<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>婚宴座位與簽到系統</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts: Noto Sans TC & Great Vibes (Cursive) -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&family=Great+Vibes&display=swap" rel="stylesheet">
    <!-- Font Awesome Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['"Noto Sans TC"', 'sans-serif'],
                        cursive: ['"Great Vibes"', 'cursive'],
                    },
                    colors: {
                        wedding: {
                            red: '#8a1c28', // 勃艮第紅
                            darkRed: '#5a121a', // 深紅背景
                            gold: '#c5a059', // 香檳金
                            light: '#fdfbf7', // 米白底色
                            green: '#4a7c59', // 簽到綠
                            pink: '#fce7e9',
                            blue: '#e0f2fe', // 男家藍
                        }
                    },
                    boxShadow: {
                        'up': '0 -10px 25px -5px rgba(0, 0, 0, 0.1), 0 -8px 10px -6px rgba(0, 0, 0, 0.1)',
                        'card': '0 4px 20px rgba(138, 28, 40, 0.08)',
                    }
                }
            }
        }
    </script>

    <style>
        body {
            background-color: #fdfbf7;
            -webkit-tap-highlight-color: transparent;
        }

        /* 花卉線條藝術背景 (Floral Line Art) */
        .floral-bg {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1;
            /* 使用淡雅的花卉線條圖案 */
            background-image: url('https://img.freepik.com/free-vector/hand-drawn-minimal-background_23-2148999829.jpg?w=1380&t=st=1703600000~exp=1703600600~hmac=fake_signature');
            background-size: 400px; /* 調整圖案大小 */
            background-repeat: repeat;
            opacity: 0.08; /* 非常淡的透明度 */
            filter: sepia(100%) hue-rotate(320deg) saturate(20%); /* 調整色調微帶紅 */
            pointer-events: none;
        }

        /* 內容遮罩：確保背景不干擾文字 */
        .content-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1;
            background: radial-gradient(circle, rgba(253,251,247,0.4) 0%, rgba(253,251,247,0.9) 100%);
            pointer-events: none;
        }

        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        .transition-all-300 { transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); }

        /* 簽到狀態樣式 */
        .guest-card.checked-in {
            background: linear-gradient(to bottom right, #f0fdf4, #dcfce7);
            border-color: #86efac;
        }
        .guest-card.checked-in .avatar-box {
            background-color: #16a34a;
            color: white;
        }
        .guest-card.checked-in .check-icon {
            opacity: 1;
            transform: scale(1);
        }
    </style>
</head>
<body class="text-gray-800 antialiased h-screen flex flex-col overflow-hidden">

    <div class="floral-bg"></div>
    <div class="content-overlay"></div>

    <div class="flex-1 overflow-y-auto no-scrollbar relative flex flex-col">
        
        <!-- Header: 勃艮第紅 + 香檳金 -->
        <header class="bg-gradient-to-br from-wedding-red to-wedding-darkRed text-white pt-12 pb-32 px-6 rounded-b-[3rem] shadow-2xl relative z-10 shrink-0 overflow-hidden">
            
            <!-- Header 內部的裝飾暗花 -->
            <div class="absolute inset-0 opacity-10" style="background-image: url('https://www.transparenttextures.com/patterns/black-linen.png');"></div>
            
            <div class="relative z-10">
                <div class="flex flex-col items-center justify-center mb-8 text-center">
                    <h2 class="text-wedding-gold text-xs font-bold tracking-[0.3em] uppercase mb-2 opacity-90">Wedding Reception</h2>
                    <!-- 草書新人名字 -->
                    <h1 class="text-5xl font-cursive text-white mb-2 drop-shadow-lg transform -rotate-2">Shirley & Oscar</h1>
                    <div class="w-16 h-0.5 bg-wedding-gold/50 rounded-full mt-2"></div>
                </div>

                <!-- 數據概覽 & 進度圈 -->
                <div class="flex justify-between items-end">
                    <div class="flex gap-3 overflow-x-auto pb-2 no-scrollbar w-full mr-4">
                        <div class="bg-white/10 backdrop-blur-md rounded-2xl p-3 min-w-[85px] border border-white/10 shadow-lg text-center">
                            <div class="text-[10px] text-gray-300 mb-1 uppercase tracking-wide">總人數</div>
                            <div class="text-xl font-bold" id="totalHeadcount">0</div>
                        </div>
                        <div class="bg-green-900/40 backdrop-blur-md rounded-2xl p-3 min-w-[85px] border border-green-400/30 shadow-lg text-center">
                            <div class="text-[10px] text-green-200 mb-1 uppercase tracking-wide">已簽到</div>
                            <div class="text-xl font-bold text-green-300" id="checkedInCount">0</div>
                        </div>
                        <div class="bg-white/10 backdrop-blur-md rounded-2xl p-3 min-w-[85px] border border-white/10 shadow-lg text-center">
                            <div class="text-[10px] text-gray-300 mb-1 uppercase tracking-wide">未到</div>
                            <div class="text-xl font-bold text-wedding-gold" id="pendingCount">0</div>
                        </div>
                    </div>

                    <!-- 總體進度圈 -->
                    <div class="relative w-14 h-14 flex items-center justify-center shrink-0 mb-2">
                        <svg class="transform -rotate-90 w-14 h-14">
                            <circle cx="28" cy="28" r="24" stroke="currentColor" stroke-width="3" fill="transparent" class="text-white/10" />
                            <circle id="progressCircle" cx="28" cy="28" r="24" stroke="#c5a059" stroke-width="3" fill="transparent" stroke-dasharray="150.7" stroke-dashoffset="150.7" class="transition-all duration-1000 ease-out" />
                        </svg>
                        <span class="absolute text-[11px] font-bold" id="progressText">0%</span>
                    </div>
                </div>
            </div>
        </header>

        <!-- Main Content -->
        <main class="-mt-20 px-4 pb-24 relative z-20 flex-1">
            
            <!-- Search -->
            <div class="bg-white rounded-2xl shadow-card p-4 mb-6 flex items-center gap-3 sticky top-4 z-30 ring-1 ring-gray-100/50">
                <div class="bg-gray-50 rounded-full w-10 h-10 flex items-center justify-center text-wedding-red/50 shrink-0">
                    <i class="fas fa-search"></i>
                </div>
                <input type="text" id="searchInput" placeholder="搜尋賓客姓名..." class="bg-transparent w-full outline-none text-gray-700 placeholder-gray-400 font-medium h-full">
                <button onclick="clearSearch()" id="clearSearchBtn" class="hidden text-gray-400 p-2"><i class="fas fa-times"></i></button>
            </div>

            <!-- Table List -->
            <div id="tablesContainer" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-5">
                <!-- JS Generated -->
            </div>

            <div class="h-20"></div>
        </main>
    </div>

    <!-- Check-in Modal -->
    <div id="checkInModal" class="fixed inset-0 bg-black/70 backdrop-blur-sm hidden items-center justify-center z-50 p-6 opacity-0 transition-opacity duration-300">
        <div class="bg-white w-full max-w-sm rounded-[2rem] shadow-2xl overflow-hidden transform scale-95 transition-transform duration-300 relative flex flex-col" id="checkInContent">
            
            <!-- Close Button -->
            <button onclick="closeModal()" class="absolute top-4 right-4 z-10 w-8 h-8 bg-gray-100 rounded-full flex items-center justify-center text-gray-500 hover:bg-gray-200">
                <i class="fas fa-times"></i>
            </button>

            <!-- Top Banner -->
            <div class="h-32 bg-gradient-to-br from-wedding-red to-wedding-darkRed relative flex items-center justify-center overflow-hidden shrink-0">
                <div class="absolute inset-0 opacity-10" style="background-image: url('https://www.transparenttextures.com/patterns/black-linen.png');"></div>
                
                <div class="absolute -bottom-8 w-20 h-20 bg-white rounded-full p-1.5 shadow-lg z-10">
                    <div class="w-full h-full bg-gray-100 rounded-full flex items-center justify-center text-3xl font-bold text-wedding-red" id="modalAvatar">
                        <i class="fas fa-user"></i>
                    </div>
                </div>
            </div>

            <!-- Content -->
            <div class="pt-12 pb-8 px-6 text-center flex-1 flex flex-col">
                <h2 class="text-2xl font-bold text-gray-800 mb-1" id="modalGuestName">Guest Name</h2>
                <p class="text-sm text-gray-500 mb-4 font-medium" id="modalGuestTable">Table X</p>

                <!-- 喜帖提示區域 -->
                
                <!-- 1. 未領喜帖提示 (預設隱藏) -->
                <div id="noInvitationAlert" class="hidden mb-4 bg-red-50 border-l-4 border-wedding-red rounded-r-xl p-4 shadow-sm animate-pulse">
                    <div class="flex flex-col items-center justify-center text-wedding-red">
                        <div class="flex items-center gap-2 mb-2">
                            <i class="fas fa-envelope text-xl"></i>
                            <span class="font-bold text-lg">請轉交喜帖一張</span>
                        </div>
                        <div class="flex items-center gap-2 bg-white px-3 py-2 rounded-lg border border-red-100 shadow-sm w-full justify-center">
                            <input type="checkbox" id="invitationCheck" class="w-5 h-5 text-wedding-red rounded focus:ring-wedding-red" onchange="toggleConfirmButton()">
                            <label for="invitationCheck" class="text-sm font-bold text-gray-700 cursor-pointer select-none">我已轉交喜帖</label>
                        </div>
                    </div>
                </div>

                <!-- 2. 已領喜帖標籤 (預設隱藏) -->
                <div id="hasInvitationBadge" class="hidden mb-6">
                    <div class="inline-flex items-center gap-2 bg-green-100 text-green-700 px-4 py-2 rounded-full font-bold text-sm border border-green-200 shadow-sm">
                        <i class="fas fa-check-circle text-green-600"></i>
                        <span>已領取喜帖</span>
                    </div>
                </div>

                <!-- Info Cards -->
                <div class="grid grid-cols-2 gap-3 mb-8">
                    <div class="bg-gray-50 rounded-xl p-3 border border-gray-100">
                        <div class="text-xs text-gray-400 uppercase font-bold tracking-wider">人數</div>
                        <div class="text-xl font-bold text-gray-800" id="modalGuestSize">1</div>
                    </div>
                    <div class="bg-gray-50 rounded-xl p-3 border border-gray-100">
                        <div class="text-xs text-gray-400 uppercase font-bold tracking-wider">狀態</div>
                        <div class="text-xl font-bold" id="modalStatusText">未簽到</div>
                    </div>
                </div>

                <!-- Action Button -->
                <button id="checkInBtn" onclick="toggleCheckIn()" class="w-full py-4 rounded-xl font-bold text-lg shadow-lg transform transition-all active:scale-95 flex items-center justify-center gap-2 mt-auto disabled:opacity-50 disabled:cursor-not-allowed">
                    <!-- Icon & Text injected by JS -->
                </button>
                
                <p class="text-xs text-gray-400 mt-4">點擊上方按鈕切換簽到狀態</p>
            </div>
        </div>
    </div>

    <script>
        // --- 數據設置 ---
        const TABLE_COUNT = 19; 
        const SEATS_PER_TABLE = 12; // 預設每桌12人
        
        // 桌號分類資訊
        const TABLE_INFO = {
            1: { title: "主家席", color: "gold" },
            2: { title: "男家長輩", color: "red" },
            3: { title: "女家長輩", color: "red" },
            5: { title: "女家親戚", color: "pink" },
            6: { title: "男家朋友", color: "blue" },
            7: { title: "男家朋友", color: "blue" },
            8: { title: "女家親戚", color: "pink" },
            9: { title: "女家朋友", color: "pink" },
            10: { title: "男家朋友", color: "blue" },
            11: { title: "男家朋友", color: "blue" },
            12: { title: "女家朋友", color: "pink" },
            13: { title: "女家朋友", color: "pink" },
            15: { title: "男家朋友", color: "blue" },
            16: { title: "男家朋友", color: "blue" },
            17: { title: "女家朋友", color: "pink" },
            18: { title: "男家朋友", color: "blue" },
            19: { title: "男家朋友", color: "blue" }
        };

        // 數據源：hasInvitation: true (已發), false (黑色字, 未發-需顯示提示)
        // 根據您的最新指示更新狀態
        let rawGuests = [
            // Table 1 (主家席)
            // 新郎媽媽 (已收)
            { name: "新郎媽媽", tableId: 1, hasInvitation: true },
            { name: "新郎姨丈(+新郎姨媽,新郎表哥,新郎表姐)", tableId: 1, manualSize: 4, hasInvitation: false },
            // 吳生+吳太 (已收)
            { name: "吳生(Mr Roger Ng)+吳太(Ms Amy Leung)", tableId: 1, manualSize: 2, hasInvitation: true },
            { name: "新郎表姨(Shirley Hui)(+表姨丈)", tableId: 1, manualSize: 2, hasInvitation: false },
            { name: "新郎大舅父 (Steven Hui) (+舅母)", tableId: 1, manualSize: 2, hasInvitation: false },
            { name: "新郎舅父(Stanley Hui) (+舅母)", tableId: 1, manualSize: 2, hasInvitation: false },
            { name: "胡生(+許小姐+胡超文)", tableId: 1, manualSize: 3, hasInvitation: false },
            // 永高老叔+老嬸 (已收)
            { name: "永高老叔(+老嬸)", tableId: 1, manualSize: 2, hasInvitation: true },
            { name: "新郎", tableId: 1, hasInvitation: true }, // 新人已收
            { name: "新娘", tableId: 1, hasInvitation: true }, // 新人已收
            
            // Table 2 (男家長輩)
            { name: "文昭舅舅(+舅母)", tableId: 2, manualSize: 2, hasInvitation: false },
            { name: "炯强舅舅(+舅母)", tableId: 2, manualSize: 2, hasInvitation: false },
            { name: "耀彬舅舅(+舅母)", tableId: 2, manualSize: 2, hasInvitation: false },
            { name: "基茂舅舅", tableId: 2, hasInvitation: false },
            { name: "盛少英(+林先生)", tableId: 2, manualSize: 2, hasInvitation: true },
            { name: "劉劍文(+劉太)", tableId: 2, manualSize: 2, hasInvitation: true },

            // Table 3 (女家長輩 - 全部已收)
            { name: "新娘爸爸", tableId: 3, hasInvitation: true }, 
            { name: "新娘媽媽", tableId: 3, hasInvitation: true }, 
            { name: "新娘嫲嫲", tableId: 3, hasInvitation: true },
            { name: "新娘外公", tableId: 3, hasInvitation: true }, 
            { name: "倩兒姨婆", tableId: 3, hasInvitation: true }, { name: "錫生舅公", tableId: 3, hasInvitation: true },
            { name: "麗兒姨婆", tableId: 3, hasInvitation: true }, { name: "燕兒姨婆", tableId: 3, hasInvitation: true }, 
            { name: "天虹姑婆", tableId: 3, hasInvitation: true }, { name: "曉虹姑婆", tableId: 3, hasInvitation: true }, 
            { name: "區清姨婆", tableId: 3, hasInvitation: true }, { name: "梅冰姨公", tableId: 3, hasInvitation: true },

            // Table 5 (女家親戚)
            { name: "徐偉舅舅", tableId: 5, hasInvitation: false }, { name: "Reiki", tableId: 5, hasInvitation: false }, 
            { name: "傅先生全家(+5位)", tableId: 5, manualSize: 6, hasInvitation: false },
            { name: "王向紅", tableId: 5, hasInvitation: true }, 
            { name: "吳承菊", tableId: 5, hasInvitation: true }, 
            { name: "吳起恕", tableId: 5, hasInvitation: true },

            // Table 6 (男家朋友)
            { name: "綺華", tableId: 6, hasInvitation: true }, { name: "錦鑾", tableId: 6, hasInvitation: true }, 
            { name: "佩華", tableId: 6, hasInvitation: true }, { name: "淑華", tableId: 6, hasInvitation: true }, 
            { name: "宋吟", tableId: 6, hasInvitation: true }, { name: "燕芬", tableId: 6, hasInvitation: true },
            { name: "玉娥", tableId: 6, hasInvitation: true }, { name: "姚晴萱", tableId: 6, hasInvitation: true }, 
            { name: "姚澤彬", tableId: 6, hasInvitation: true }, { name: "劉子鈞(+3位)", tableId: 6, manualSize: 4, hasInvitation: true },

            // Table 7 (男家朋友)
            // 徐總, Jimmy (已收)
            { name: "吳总", tableId: 7, hasInvitation: true }, { name: "Carly Ng", tableId: 7, hasInvitation: true }, 
            { name: "徐生", tableId: 7, hasInvitation: true }, { name: "Stephanus (+4)", tableId: 7, manualSize: 5, hasInvitation: true },
            { name: "Roberto (+1)", tableId: 7, manualSize: 2, hasInvitation: true },
            { name: "徐總", tableId: 7, hasInvitation: true }, { name: "Jimmy", tableId: 7, hasInvitation: true },

            // Table 8 (女家親戚)
            { name: "梅士平叔叔", tableId: 8, hasInvitation: false }, { name: "燕華嬸嬸", tableId: 8, hasInvitation: false }, 
            { name: "玟鏵姑姐", tableId: 8, hasInvitation: false }, { name: "海歐叔叔", tableId: 8, hasInvitation: false }, 
            { name: "黃沛瑜", tableId: 8, hasInvitation: false }, 
            { name: "黃海洋(+1位)", tableId: 8, manualSize: 2, hasInvitation: false }, 
            { name: "斌毅舅舅全家(+2位)", tableId: 8, manualSize: 3, hasInvitation: true }, 
            { name: "Alex Wong", tableId: 8, hasInvitation: true }, { name: "Jack Wong", tableId: 8, hasInvitation: true },

            // Table 9 (女家朋友)
            { name: "Leila", tableId: 9, hasInvitation: true }, { name: "Ana", tableId: 9, hasInvitation: true }, 
            { name: "Gavin", tableId: 9, hasInvitation: true }, { name: "Davina", tableId: 9, hasInvitation: true }, 
            { name: "Catherine", tableId: 9, hasInvitation: true }, { name: "Lemon", tableId: 9, hasInvitation: true },
            { name: "Nora", tableId: 9, hasInvitation: true }, { name: "Brian", tableId: 9, hasInvitation: true }, 
            { name: "Kiki", tableId: 9, hasInvitation: true }, { name: "Jorie", tableId: 9, hasInvitation: true }, 
            { name: "Yichen", tableId: 9, hasInvitation: true }, { name: "Katia", tableId: 9, hasInvitation: true },

            // Table 10 (男家朋友)
            // 陳凱偉 (已收)
            { name: "大眼仔2", tableId: 10, manualSize: 2, hasInvitation: true }, 
            { name: "Ng Ming Kin(+3位)", tableId: 10, manualSize: 4, hasInvitation: true }, 
            { name: "Sunkist Sit", tableId: 10, hasInvitation: true },
            { name: "陳凱偉", tableId: 10, hasInvitation: true }, 
            { name: "黃國翹(+1位)", tableId: 10, manualSize: 2, hasInvitation: true }, 
            { name: "方齊發(+1位)", tableId: 10, manualSize: 2, hasInvitation: true },

            // Table 11 (男家朋友)
            // Sammi, Crystal, Michelle, Joe Lo (已收)
            { name: "Sammi", tableId: 11, hasInvitation: true }, { name: "Crystal", tableId: 11, hasInvitation: true }, 
            { name: "Michelle", tableId: 11, hasInvitation: true }, { name: "Joe Lo", tableId: 11, hasInvitation: true }, 
            { name: "Winky Chau", tableId: 11, hasInvitation: false }, 
            { name: "鄭國鏘(+3位)", tableId: 11, manualSize: 4, hasInvitation: true },
            { name: "Kathy Keh", tableId: 11, hasInvitation: false }, { name: "Kayleen Keh", tableId: 11, hasInvitation: false }, 
            { name: "Miyuki sze", tableId: 11, hasInvitation: false },

            // Table 12 (女家朋友)
            { name: "Phoebe", tableId: 12, hasInvitation: true }, { name: "Tingting", tableId: 12, hasInvitation: true }, 
            { name: "Darren", tableId: 12, hasInvitation: true }, { name: "Chris", tableId: 12, hasInvitation: true }, 
            { name: "Siann", tableId: 12, hasInvitation: true }, { name: "Miror", tableId: 12, hasInvitation: true },
            { name: "KC", tableId: 12, hasInvitation: true }, { name: "Brian", tableId: 12, hasInvitation: true }, 
            { name: "Wilson", tableId: 12, hasInvitation: true }, { name: "Andy", tableId: 12, hasInvitation: true }, 
            { name: "Anthony", tableId: 12, hasInvitation: true }, { name: "justin", tableId: 12, hasInvitation: true },

            // Table 13 (女家朋友)
            { name: "Kelly(+3位)", tableId: 13, manualSize: 4, hasInvitation: true }, 
            { name: "Lancy", tableId: 13, hasInvitation: false }, { name: "Betty", tableId: 13, hasInvitation: false }, 
            { name: "Lauren (+1位)", tableId: 13, manualSize: 2, hasInvitation: false }, 
            { name: "Linda Pak (+2位)", tableId: 13, manualSize: 3, hasInvitation: false },

            // Table 15 (男家朋友)
            // Jason Wong, Wiliam Wong, James Lo, Nik Po, 林霞, 凌生, 林生, 劉总, Sanda Tsang, Lala (已收)
            { name: "Jason Wong", tableId: 15, hasInvitation: true }, { name: "Wiliam Wong", tableId: 15, hasInvitation: true }, 
            { name: "James Lo", tableId: 15, hasInvitation: true }, { name: "Nik Po", tableId: 15, hasInvitation: true }, 
            { name: "林霞", tableId: 15, hasInvitation: true }, { name: "凌生", tableId: 15, hasInvitation: true },
            { name: "張天永", tableId: 15, hasInvitation: false }, 
            { name: "林生(2位)", tableId: 15, manualSize: 2, hasInvitation: true }, 
            { name: "劉总", tableId: 15, hasInvitation: true },
            { name: "Sanda Tsang", tableId: 15, hasInvitation: true }, { name: "Lala", tableId: 15, hasInvitation: true },

            // Table 16 (男家朋友)
            // Rannie Yu (已收)
            { name: "暢(兒子)", tableId: 16, hasInvitation: true }, { name: "葉堡琛", tableId: 16, hasInvitation: true }, 
            { name: "劉子軒(3位)", tableId: 16, manualSize: 3, hasInvitation: true },
            { name: "林綺婷", tableId: 16, hasInvitation: true }, { name: "朱岸南", tableId: 16, hasInvitation: true }, 
            { name: "Dicky Cheung", tableId: 16, hasInvitation: true }, { name: "Karen Law", tableId: 16, hasInvitation: true }, 
            { name: "范嘉俊", tableId: 16, hasInvitation: true }, { name: "任旭陽", tableId: 16, hasInvitation: true },
            { name: "Rannie Yu", tableId: 16, hasInvitation: true },

            // Table 17 (女家朋友)
            { name: "Denise", tableId: 17, hasInvitation: true }, { name: "Leo", tableId: 17, hasInvitation: true }, 
            { name: "Gloria", tableId: 17, hasInvitation: true }, { name: "Mackie", tableId: 17, hasInvitation: true }, 
            { name: "Brina", tableId: 17, hasInvitation: true }, { name: "Ashley", tableId: 17, hasInvitation: true },
            { name: "Shiiko", tableId: 17, hasInvitation: true }, { name: "Jaye", tableId: 17, hasInvitation: false }, 
            { name: "Cheryl", tableId: 17, hasInvitation: false }, { name: "Betsy", tableId: 17, hasInvitation: false }, 
            { name: "Joe", tableId: 17, hasInvitation: false }, { name: "Pakki", tableId: 17, hasInvitation: false },

            // Table 18 (男家朋友)
            { name: "Crystal", tableId: 18, hasInvitation: true }, { name: "Ada", tableId: 18, hasInvitation: true }, 
            { name: "Angel", tableId: 18, hasInvitation: true }, { name: "Celia", tableId: 18, hasInvitation: true }, 
            { name: "Siu Yuk", tableId: 18, hasInvitation: true }, { name: "Momoco", tableId: 18, hasInvitation: true },
            { name: "Alison", tableId: 18, hasInvitation: true }, { name: "陳嘉安", tableId: 18, hasInvitation: true }, 
            { name: "John", tableId: 18, hasInvitation: true }, { name: "Or fu", tableId: 18, hasInvitation: true },

            // Table 19 (男家朋友)
            // Kelvin Li, Matt, Hayley, Ivy, Ting fung, Roxanne, Gigi, Bonnie, Vicky, Moon, Sandra, Cling (全部已收)
            { name: "Kelvin Li", tableId: 19, hasInvitation: true }, { name: "Matt", tableId: 19, hasInvitation: true }, 
            { name: "Hayley", tableId: 19, hasInvitation: true }, { name: "Ivy", tableId: 19, hasInvitation: true }, 
            { name: "Ting fung", tableId: 19, hasInvitation: true }, { name: "Roxanne", tableId: 19, hasInvitation: true },
            { name: "Gigi", tableId: 19, hasInvitation: true }, { name: "Bonnie", tableId: 19, hasInvitation: true }, 
            { name: "Vicky", tableId: 19, hasInvitation: true }, { name: "Moon", tableId: 19, hasInvitation: true }, 
            { name: "Sandra", tableId: 19, hasInvitation: true }, { name: "Cling", tableId: 19, hasInvitation: true },
        ];

        let guests = [];
        let currentGuestId = null;

        document.addEventListener('DOMContentLoaded', () => {
            initGuests();
            renderApp();
            setupSearch();
        });

        // 解析人數邏輯
        function initGuests() {
            guests = rawGuests.map((g, index) => {
                let size = 1;
                if (g.manualSize) {
                    size = g.manualSize;
                } else {
                    const name = g.name;
                    // 自動解析 (+N) 或 N位
                    const plusMatch = name.match(/\(\+(\d+)(?:位|人)?\)/); // 匹配 (+3), (+3位)
                    if (plusMatch) size = 1 + parseInt(plusMatch[1]);
                    
                    const bracketMatch = name.match(/\((\d+)[位人]\)/); // 匹配 (3位)
                    if (bracketMatch) size = parseInt(bracketMatch[1]);
                    
                    const spaceNumMatch = name.match(/\s(\d+)$/); // 匹配 Name 2
                    if (spaceNumMatch) size = parseInt(spaceNumMatch[1]);
                    
                    // 特殊: 伉儷 = 2人
                    if (name.includes("伉儷") && !plusMatch && !bracketMatch) size = 2;
                }
                return {
                    id: index + 1,
                    name: g.name,
                    tableId: g.tableId,
                    size: size,
                    checkedIn: false,
                    // 確保 hasInvitation 有預設值，未定義則視為 false (黑色字)
                    hasInvitation: g.hasInvitation === true 
                };
            });
        }

        function renderApp() {
            renderStats();
            renderTables();
        }

        function renderStats() {
            const totalHeadcount = guests.reduce((sum, g) => sum + g.size, 0);
            const checkedInHeadcount = guests.filter(g => g.checkedIn).reduce((sum, g) => sum + g.size, 0);
            const pendingHeadcount = totalHeadcount - checkedInHeadcount;

            animateValue("totalHeadcount", parseInt(document.getElementById("totalHeadcount").innerText), totalHeadcount, 500);
            animateValue("checkedInCount", parseInt(document.getElementById("checkedInCount").innerText), checkedInHeadcount, 500);
            document.getElementById('pendingCount').innerText = pendingHeadcount;

            const percentage = totalHeadcount > 0 ? (checkedInHeadcount / totalHeadcount) * 100 : 0;
            const circle = document.getElementById('progressCircle');
            const radius = 24; 
            const circumference = 2 * Math.PI * radius;
            const offset = circumference - (percentage / 100) * circumference;
            circle.style.strokeDasharray = `${circumference} ${circumference}`;
            circle.style.strokeDashoffset = offset;
            document.getElementById('progressText').innerText = Math.round(percentage) + '%';
        }

        function animateValue(id, start, end, duration) {
            if (start === end) return;
            const range = end - start;
            let current = start;
            const increment = end > start ? 1 : -1;
            const stepTime = Math.abs(Math.floor(duration / range));
            const obj = document.getElementById(id);
            const timer = setInterval(function() {
                current += increment;
                obj.innerHTML = current;
                if (current == end) {
                    clearInterval(timer);
                }
            }, stepTime > 100 ? 100 : stepTime);
        }

        function renderTables() {
            const container = document.getElementById('tablesContainer');
            container.innerHTML = '';
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();

            for (let i = 1; i <= TABLE_COUNT; i++) {
                // 跳過不存在的桌號
                if (i === 4 || i === 14) continue;

                let tableGuests = guests.filter(g => g.tableId === i);
                if (searchTerm) {
                    const hasMatch = tableGuests.some(g => g.name.toLowerCase().includes(searchTerm));
                    if (!hasMatch) continue;
                }

                const currentHeadcount = tableGuests.reduce((sum, g) => sum + g.size, 0);
                const isOverCapacity = currentHeadcount > SEATS_PER_TABLE;

                // --- 配色邏輯 ---
                const info = TABLE_INFO[i] || { title: `第 ${i} 桌`, color: 'gray' };
                
                let headerBg, borderColor, titleColor, subTitle, iconBg, iconColor;

                if (info.color === "gold") { // 主家席
                    headerBg = 'bg-gradient-to-r from-wedding-gold/20 to-white';
                    titleColor = 'text-[#856404]'; 
                    borderColor = 'border-wedding-gold/40';
                    iconBg = 'bg-wedding-gold/20';
                    iconColor = 'text-[#856404]';
                    subTitle = `<span class="text-xs text-wedding-gold font-bold ml-2">(${info.title})</span>`;
                } else if (info.color === "red") { // 長輩席
                    headerBg = 'bg-gradient-to-r from-wedding-red/10 to-white'; 
                    titleColor = 'text-wedding-red'; 
                    borderColor = 'border-wedding-red/20';
                    iconBg = 'bg-wedding-red/10';
                    iconColor = 'text-wedding-red';
                    subTitle = `<span class="text-xs text-wedding-red font-bold ml-2">(${info.title})</span>`;
                } else if (info.color === "blue") { // 男家
                    headerBg = 'bg-gradient-to-r from-blue-100 to-white'; 
                    titleColor = 'text-blue-800'; 
                    borderColor = 'border-blue-200';
                    iconBg = 'bg-blue-100';
                    iconColor = 'text-blue-600';
                    subTitle = `<span class="text-xs text-blue-600 font-bold ml-2">(${info.title})</span>`;
                } else if (info.color === "pink") { // 女家
                    headerBg = 'bg-gradient-to-r from-pink-100 to-white'; 
                    titleColor = 'text-pink-800'; 
                    borderColor = 'border-pink-200';
                    iconBg = 'bg-pink-100';
                    iconColor = 'text-pink-600';
                    subTitle = `<span class="text-xs text-pink-600 font-bold ml-2">(${info.title})</span>`;
                } else { // 朋友席/一般
                    headerBg = 'bg-white';
                    titleColor = 'text-gray-800';
                    borderColor = 'border-transparent';
                    iconBg = 'bg-gray-100';
                    iconColor = 'text-gray-400';
                    subTitle = `<span class="text-xs text-gray-400 font-normal ml-2">${info.title}</span>`;
                }

                let cardHTML = `
                    <div class="bg-white/90 backdrop-blur-sm rounded-3xl shadow-card overflow-hidden border-2 ${borderColor} transition-all duration-300 hover:shadow-xl group-hover:border-wedding-gold/30">
                        <div class="p-4 border-b border-gray-100 flex justify-between items-center ${headerBg}">
                            <div class="flex items-center">
                                <div class="w-8 h-8 rounded-full ${iconBg} ${iconColor} flex items-center justify-center font-bold text-sm mr-2">
                                    ${i}
                                </div>
                                <h3 class="font-bold text-lg ${titleColor}">第 ${i} 桌${subTitle}</h3>
                            </div>
                            <span class="text-xs font-bold ${isOverCapacity ? 'text-red-500' : 'text-gray-400'} bg-gray-50 px-2 py-1 rounded-lg">
                                <i class="fas fa-users mr-1"></i> ${currentHeadcount}/${SEATS_PER_TABLE}
                            </span>
                        </div>
                        
                        <div class="p-3 min-h-[80px]">
                            <div class="flex flex-wrap gap-2">
                                ${tableGuests.map(guest => {
                                    const isMatch = searchTerm && guest.name.toLowerCase().includes(searchTerm);
                                    const opacityClass = searchTerm && !isMatch ? 'opacity-30' : 'opacity-100';
                                    
                                    return `
                                    <div onclick="openCheckInModal(${guest.id})" class="guest-card ${guest.checkedIn ? 'checked-in' : 'bg-gray-50'} ${opacityClass} cursor-pointer group relative border border-gray-100 rounded-xl px-3 py-2 flex items-center transition-all duration-200 hover:scale-105 active:scale-95 w-full sm:w-auto hover:border-wedding-gold/30 hover:shadow-md">
                                        <div class="avatar-box w-8 h-8 rounded-full ${guest.checkedIn ? 'bg-wedding-green text-white' : 'bg-white text-gray-300'} flex items-center justify-center text-xs font-bold mr-3 shadow-sm transition-colors">
                                            ${guest.checkedIn ? '<i class="fas fa-check"></i>' : (guest.size > 1 ? guest.size : '<i class="fas fa-user"></i>')}
                                        </div>
                                        
                                        <div class="flex-1">
                                            <div class="text-sm font-bold text-gray-700 leading-tight flex items-center justify-between">
                                                <span>${guest.name}</span>
                                            </div>
                                            ${guest.size > 1 ? `<div class="text-[10px] text-gray-400 font-medium">共 ${guest.size} 位</div>` : ''}
                                        </div>

                                        ${guest.checkedIn ? '<div class="absolute right-2 top-1/2 transform -translate-y-1/2 text-wedding-green/20 text-4xl -z-0 pointer-events-none"><i class="fas fa-check-circle"></i></div>' : ''}
                                    </div>
                                `}).join('')}
                            </div>
                        </div>
                    </div>
                `;
                container.innerHTML += cardHTML;
            }
        }

        // --- 簽到 Modal 邏輯 ---
        function openCheckInModal(id) {
            currentGuestId = id;
            const guest = guests.find(g => g.id === id);
            const modal = document.getElementById('checkInModal');
            const content = document.getElementById('checkInContent');
            const noInvitationAlert = document.getElementById('noInvitationAlert');
            const hasInvitationBadge = document.getElementById('hasInvitationBadge');
            const invitationCheck = document.getElementById('invitationCheck');
            const checkInBtn = document.getElementById('checkInBtn');
            
            document.getElementById('modalGuestName').innerText = guest.name;
            document.getElementById('modalGuestTable').innerText = `第 ${guest.tableId} 桌`;
            document.getElementById('modalGuestSize').innerText = `${guest.size} 人`;
            
            // 重置 checkbox 狀態
            invitationCheck.checked = false;

            // 邏輯: 
            // 1. 如果已簽到，不顯示喜帖提示，顯示「取消簽到」按鈕
            // 2. 如果未簽到:
            //    a. hasInvitation = true: 顯示綠色標籤，按鈕可用
            //    b. hasInvitation = false: 顯示紅色提示+checkbox，按鈕禁用 (直到勾選)
            
            if (guest.checkedIn) {
                noInvitationAlert.classList.add('hidden');
                hasInvitationBadge.classList.add('hidden');
                checkInBtn.disabled = false;
                checkInBtn.classList.remove('opacity-50', 'cursor-not-allowed');
                updateCheckInBtnUI(true);
            } else {
                if (guest.hasInvitation) {
                    // 已領喜帖
                    noInvitationAlert.classList.add('hidden');
                    hasInvitationBadge.classList.remove('hidden');
                    checkInBtn.disabled = false;
                    checkInBtn.classList.remove('opacity-50', 'cursor-not-allowed');
                } else {
                    // 未領喜帖
                    noInvitationAlert.classList.remove('hidden');
                    hasInvitationBadge.classList.add('hidden');
                    checkInBtn.disabled = true; // 鎖定按鈕
                    checkInBtn.classList.add('opacity-50', 'cursor-not-allowed');
                }
                updateCheckInBtnUI(false);
            }

            modal.classList.remove('hidden');
            modal.classList.add('flex');
            setTimeout(() => {
                modal.classList.remove('opacity-0');
                content.classList.remove('scale-95');
                content.classList.add('scale-100');
            }, 10);
        }

        // checkbox 變更事件
        function toggleConfirmButton() {
            const checkInBtn = document.getElementById('checkInBtn');
            const checkbox = document.getElementById('invitationCheck');
            
            if (checkbox.checked) {
                checkInBtn.disabled = false;
                checkInBtn.classList.remove('opacity-50', 'cursor-not-allowed');
            } else {
                checkInBtn.disabled = true;
                checkInBtn.classList.add('opacity-50', 'cursor-not-allowed');
            }
        }

        function updateCheckInBtnUI(checkedIn) {
            const btn = document.getElementById('checkInBtn');
            const statusText = document.getElementById('modalStatusText');
            const avatar = document.getElementById('modalAvatar');

            if (checkedIn) {
                btn.className = "w-full py-4 rounded-xl font-bold text-lg shadow-lg transform transition-all active:scale-95 flex items-center justify-center gap-2 bg-gray-100 text-gray-500 hover:bg-gray-200 mt-auto";
                btn.innerHTML = '<i class="fas fa-undo"></i> <span>取消簽到</span>';
                statusText.innerText = "已簽到";
                statusText.className = "text-xl font-bold text-green-600";
                avatar.className = "w-full h-full bg-green-100 rounded-full flex items-center justify-center text-3xl font-bold text-green-600 transition-colors";
                avatar.innerHTML = '<i class="fas fa-check"></i>';
            } else {
                // 按鈕樣式由 openCheckInModal 中的 disabled 屬性控制透明度
                // 這裡只設定基本的啟用樣式 (顏色)
                btn.className = "w-full py-4 rounded-xl font-bold text-lg shadow-lg transform transition-all active:scale-95 flex items-center justify-center gap-2 bg-wedding-green text-white shadow-green-200 mt-auto disabled:opacity-50 disabled:cursor-not-allowed";
                btn.innerHTML = '<i class="fas fa-check-circle"></i> <span>確認簽到</span>';
                statusText.innerText = "未簽到";
                statusText.className = "text-xl font-bold text-gray-400";
                avatar.className = "w-full h-full bg-gray-100 rounded-full flex items-center justify-center text-3xl font-bold text-gray-400 transition-colors";
                avatar.innerHTML = '<i class="fas fa-user"></i>';
            }
        }

        function toggleCheckIn() {
            const guest = guests.find(g => g.id === currentGuestId);
            guest.checkedIn = !guest.checkedIn;
            
            // 如果是剛完成簽到，且原本是未領喜帖者，視為已領取 (更新狀態以免取消後再簽到又要勾選)
            // 不過為了保險，這裡暫不永久修改 hasInvitation，只處理當次簽到邏輯
            
            updateCheckInBtnUI(guest.checkedIn);
            renderApp();
            
            // 延遲關閉
            setTimeout(() => {
                closeModal();
            }, 500);
        }

        function closeModal() {
            const modal = document.getElementById('checkInModal');
            const content = document.getElementById('checkInContent');
            
            modal.classList.add('opacity-0');
            content.classList.remove('scale-100');
            content.classList.add('scale-95');
            
            setTimeout(() => {
                modal.classList.remove('flex');
                modal.classList.add('hidden');
            }, 300);
        }

        function setupSearch() {
            const input = document.getElementById('searchInput');
            const btn = document.getElementById('clearSearchBtn');
            input.addEventListener('input', (e) => {
                if(e.target.value) btn.classList.remove('hidden');
                else btn.classList.add('hidden');
                renderTables();
            });
        }

        function clearSearch() {
            const input = document.getElementById('searchInput');
            input.value = '';
            document.getElementById('clearSearchBtn').classList.add('hidden');
            renderTables();
        }
    </script>
</body>
</html>
